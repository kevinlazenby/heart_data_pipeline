---
title: "create_post_policy_dataset"
author: "Kevin Lazenby"
date: "12/21/2021"
output:
  pdf_document:
    toc: yes
    toc_depth: '2'
  html_notebook:
    theme: journal
    toc: yes
    toc_depth: 2
    toc_float: yes
---

# Setup

```{r setup, include=FALSE}

library(knitr)
opts_chunk$set(comment = NA, prompt = FALSE, cache = FALSE, echo = TRUE,
                      results = "asis")

library(tidyverse)
library(haven)
library(rmdformats)
library(dplyr)
library(tidyr)
library(ggpubr)
library(here)
library(readr)
library(lubridate)
library(boxr)
library(zoo)

here::i_am("create_post_policy_dataset.Rmd")
```

# 1. Import data sets from SRTR

```{r load data}

curr_data_release <- "pubsaf2103"

cand_thor <- read_sas(here(curr_data_release, "cand_thor.sas7bdat"), NULL) %>%  
  zap_formats() %>% zap_labels()

stat_just_hr1a <- read_sas(here(curr_data_release, "statjust_hr1a.sas7bdat"), NULL) %>%  
  zap_formats() %>% zap_labels()

stat_just_hr1b <- read_sas(here(curr_data_release, "statjust_hr1b.sas7bdat"), NULL) %>%  
  zap_formats() %>% zap_labels()

just_form_hr <- read_sas(here(curr_data_release, "JustFormHR.sas7bdat"), NULL) %>%  
  zap_formats() %>% zap_labels()

just_form_hr_stat1 <- 
  read_sas(here(curr_data_release, "JustFormHRStat1.sas7bdat"), NULL) %>%  
  zap_formats() %>% zap_labels()

just_form_hr_stat2 <- 
  read_sas(here(curr_data_release, "JustFormHRStat2.sas7bdat"), NULL) %>%  
  zap_formats() %>% zap_labels()

just_form_hr_stat3 <- 
  read_sas(here(curr_data_release, "JustFormHRStat3.sas7bdat"), NULL) %>%  
  zap_formats() %>% zap_labels()

just_form_hr_stat4 <- 
  read_sas(here(curr_data_release, "JustFormHRStat4.sas7bdat"), NULL) %>%  
  zap_formats() %>% zap_labels()

risk_strat_data_hr <- 
  read_sas(here(curr_data_release, "RiskStratDataHR.sas7bdat"), NULL) %>%  
  zap_formats() %>% zap_labels()

just_form_hr_data_link <- 
  read_sas(here(curr_data_release, "JustFormHRDataLink.sas7bdat"), NULL) %>%  
  zap_formats() %>% zap_labels()

column_descriptions <- 
  read_sas(here(curr_data_release, "ColumnDescriptions.sas7bdat"), NULL) %>%  
  zap_formats() %>% zap_labels()

table_descriptions <- 
  read_sas(here(curr_data_release, "TableDescriptions.sas7bdat"), NULL) %>%  
  zap_formats() %>% zap_labels()

stathist_thor <- 
  read_sas(here(curr_data_release, "stathist_thor.sas7bdat"), NULL) %>%  
  zap_formats() %>% zap_labels()

status_just_episode <- 
  read_sas(here(curr_data_release, "StatusJustEpisode.sas7bdat"), NULL) %>%
  zap_formats() %>% zap_labels()

thor_support_device <- 
  read_sas(here(curr_data_release, "ThorSupportDevice.sas7bdat"), NULL) %>% 
  zap_formats() %>% zap_labels()

tx_hr <- read_sas(here(curr_data_release, "tx_hr.sas7bdat"), NULL) %>%  
  zap_formats() %>% zap_labels()
```

# 2. Link data sets using JustId, WlregAuditId, and PX_ID
#     a. common linking variable after this block is PX_ID

```{r link data sets}

just_form_hr_data_link <- just_form_hr_data_link %>% 
  left_join(risk_strat_data_hr %>%
              select(px_id, WlregAuditId), by = "WlregAuditId") %>% 
  mutate(PX_ID = px_id) %>% select(-px_id)

just_form_hr <- just_form_hr %>% 
  left_join(just_form_hr_data_link %>% select(JustId, PX_ID), by = "JustId")

just_form_hr_stat1 <- just_form_hr_stat1 %>% 
  left_join(just_form_hr_data_link %>% select(JustId, PX_ID), by = "JustId")

just_form_hr_stat2 <- just_form_hr_stat2 %>% 
  left_join(just_form_hr_data_link %>% select(JustId, PX_ID), by = "JustId")

just_form_hr_stat3 <- just_form_hr_stat3 %>% 
  left_join(just_form_hr_data_link %>% select(JustId, PX_ID), by = "JustId")

just_form_hr_stat4 <- just_form_hr_stat4 %>% 
  left_join(just_form_hr_data_link %>% select(JustId, PX_ID), by = "JustId")

```


# 3. Tidy input datasets
#     a. Filter out candidates listed before new policy implementation
#     b. Filter in adult, heart-only transplant candidates
#     c. Remove variables which are missing or irrelevant

```{r apply exclusion criteria}
policy_switch_date <- mdy("10/18/2018")

multi_organ_recipients <- tx_hr %>% 
  filter(REC_TX_TY == 2 | REC_TX_TY == 4) %>% 
	select(PX_ID, REC_TX_TY)

# filter candidates based on inclusion/exclusion criteria to create initial listing state
full_list_post <- cand_thor %>% 
  filter(CAN_LISTING_DT >= policy_switch_date) %>% 
  filter(WL_ORG == "HR") %>% 
  filter(CAN_INIT_STAT != 2150) %>% 
  filter(CAN_AGE_AT_LISTING > 17) %>% 
  filter(!(PX_ID %in% multi_organ_recipients$PX_ID))

# risk stratification data from post-policy era
risk_strat_post <- risk_strat_data_hr %>% 
  mutate(PX_ID = px_id) %>% select(-px_id) %>%
  filter(PX_ID %in% full_list_post$PX_ID)

# status history file from post-policy era
stathist_post <- stathist_thor %>% filter(PX_ID %in% full_list_post$PX_ID)

# justification forms from post-policy era
just_form_post <- just_form_hr %>% filter(PX_ID %in% full_list_post$PX_ID)

# data linking dataframe from post-policy era
data_link_post <- just_form_hr_data_link %>% filter(PX_ID %in% full_list_post$PX_ID)

# Status 1 justification forms from post-policy era
just_stat1_post <- just_form_hr_stat1 %>% filter(PX_ID %in% full_list_post$PX_ID)

# Status 2 justification forms from post-policy era
just_stat2_post <- just_form_hr_stat2 %>% filter(PX_ID %in% full_list_post$PX_ID)

# Status 3 justification forms from post-policy era
just_stat3_post <- just_form_hr_stat3 %>% filter(PX_ID %in% full_list_post$PX_ID)

# Status 4 justification forms from post-policy era
just_stat4_post <- just_form_hr_stat4 %>% filter(PX_ID %in% full_list_post$PX_ID)

# this block selects the 46 variables in cand_thor currently used in analysis
# CAN_DRUG_TREAT_HYPERTEN, completely missing post-policy
# CAN_PERIPH_VASC, completely missing post-policy
# CAN_ANTI_ARRYTHM, completely missing post-policy
# CAN_OTHER_TOBACCO_USE, completely missing post-policy
# CAN_PULM_EMBOL, completely missing post-policy
full_list_post <- full_list_post %>% 
  select(
    PX_ID,
    WL_ORG,
    CAN_GENDER,
    CAN_ABO,
    CAN_RACE,
    PERS_SSA_DEATH_DT,
    PERS_OPTN_DEATH_DT,
    PERS_RESTRICT_DEATH_DT,
    CAN_LISTING_DT,
    CAN_REM_DT,
    CAN_REM_CD,
    CAN_DGN,
    CAN_ECMO,
    CAN_VENTILATOR,
    CAN_IABP,
    CAN_IV_INOTROP,
    CAN_VAD_TY,
    CAN_VAD1,
    CAN_PRIMARY_PAY,
    CAN_HGT_CM,
    CAN_WGT_KG,
    CAN_BMI,
    CAN_DIAB_TY,
    CAN_DIAL,
    CAN_CEREB_VASC,
    CAN_MOST_RECENT_CREAT,
    CAN_TOT_ALBUMIN,
    CAN_IMPLANT_DEFIB,
    CAN_PULM_ART_MEAN,
    CAN_PCW_MEAN,
    CAN_CARDIAC_OUTPUT,
    CAN_HIST_CIGARETTE,
    CAN_MALIG,
    CAN_LAST_STAT,
    CAN_AGE_IN_MONTHS_AT_LISTING,
    CAN_LAST_ACT_STAT_DT,
    CAN_LAST_INACT_STAT_DT,
    CAN_INIT_STAT,
    CAN_ANGINA,
    CAN_ANGINA_CAD,
    CAN_PEPTIC_ULCER,
    CAN_EXERCISE_O2)

missing_data_check <- tibble(
  pct_missing = vector(mode = "double", length = ncol(full_list_post)),
  var_names = colnames(full_list_post))

for (i in 1:ncol(full_list_post)) {
  
  missing_data_check$pct_missing[i] <-
    sum(is.na(full_list_post[, i])) / nrow(full_list_post)
}

missing_data_check <- missing_data_check %>% 
  filter(pct_missing == 1) %>% 
  arrange(desc(pct_missing))

# this line removes 4 variables from full_list_post which are completely missing
# Variable names: CAN_ANGINA, CAN_ANGINA_CAD, CAN_PEPTIC_ULCER, CAN_TOT_ALBUMIN
full_list_post <- full_list_post %>% select(-missing_data_check$var_names)

```

# 4. Pivot cand_thor and tx_hr by date, then full_join

```{r}
full_list_post <- full_list_post %>%
  distinct() %>% 
  pivot_longer(cols = ends_with("DT"),
               names_to = "event", 
               values_to = "date", 
               values_drop_na = TRUE) %>%
  arrange(date) %>% 
  group_by(date) %>% 
  mutate(unique_date = date) %>%
  group_by(PX_ID, date) %>% 
  mutate(unique_event = str_c(event, collapse = ",")) %>% 
  pivot_wider(names_from = event, values_from = date) %>% 
  arrange(PX_ID, unique_date) %>% 
  ungroup() %>%
  select(PX_ID, unique_event, unique_date, 
         WL_ORG:CAN_EXERCISE_O2)

tx_hr_post <- tx_hr %>% 
  filter(PX_ID %in% full_list_post$PX_ID) %>% 
  distinct() %>% 
  select(PX_ID, ORG_TY, REC_TX_DT, REC_POSTX_LOS, REC_A_MM_EQUIV_TX,
                     REC_B_MM_EQUIV_TX, REC_DR_MM_EQUIV_TX, REC_DGN, REC_CTR_CD,
                     REC_CTR_TY, REC_PX_STAT, REC_PX_STAT_DT,
                     REC_DISCHRG_DT, REC_ADMISSION_DT, REC_MED_COND, 
                     REC_FUNCTN_STAT, REC_PRIMARY_PAY, REC_HGT_CM, REC_WGT_KG,
                     REC_BMI, REC_HIV_STAT, REC_CMV_STAT, REC_HCV_STAT,
                     REC_EBV_STAT, REC_LIFE_SUPPORT, REC_ECMO,
                     REC_IABP, REC_PGE, REC_INOTROP, REC_VENTILATOR, REC_VAD1,
                     REC_VAD2, REC_CREAT, REC_TOT_BILI, REC_CHRONIC_STEROIDS,
                     REC_TXFUS, REC_INFECT_IV_DRUG, REC_DIAL, 
                     REC_VENTILATOR_SUPPORT, REC_HR_ISCH, REC_POSTX_STROKE,
                     REC_POSTX_DIAL, REC_POSTX_PACEMAKER,
                     REC_ACUTE_REJ_EPISODE, REC_CTR_ID, REC_AGE_IN_MONTHS_AT_TX,
                     REC_A1, REC_A2, REC_B1, REC_B2, REC_DR1, REC_DR2,
                     TFL_LASTATUS, TFL_GRAFT_DT, TFL_DEATH_DT, PERS_RETX,
                     TFL_LAFUDATE, REC_MM_EQUIV_TX)

tx_hr_missing_data_check <- tibble(
  pct_missing = vector(mode = "double", length = ncol(tx_hr_post)),
  var_names = colnames(tx_hr_post))

for (i in 1:ncol(tx_hr_post)) {
  
  tx_hr_missing_data_check$pct_missing[i] <-
    sum(is.na(tx_hr_post[, i])) / nrow(tx_hr_post)
}

tx_hr_missing_data_check <- tx_hr_missing_data_check %>% 
  filter(pct_missing == 1) %>% 
  arrange(desc(pct_missing))

# this line removes 0 variables from tx_hr_post which are completely missing
tx_hr_post <- tx_hr_post %>% select(-tx_hr_missing_data_check$var_names)


tx_hr_post <- tx_hr_post %>% 
  mutate(TFL_LAST_FU_DT = TFL_LAFUDATE) %>%
  select(-TFL_LAFUDATE) %>% 
  pivot_longer(cols = ends_with("DT"),
               names_to = "event", 
               values_to = "date", 
               values_drop_na = TRUE) %>%
  arrange(date) %>% 
  group_by(date) %>% 
  mutate(unique_date = date) %>%
  group_by(PX_ID, date) %>% 
  mutate(unique_event = str_c(event, collapse = ",")) %>% 
  pivot_wider(names_from = event, values_from = date) %>% 
  arrange(PX_ID, unique_date) %>% 
  ungroup() %>% 
  select(PX_ID, unique_event, unique_date, ORG_TY:REC_MM_EQUIV_TX)

full_list_post <- full_list_post %>% 
  
  # full join by common variables, thus no need for suffix
  full_join(tx_hr_post, by = c("PX_ID", "unique_date", "unique_event")) %>% 
  
  # combines events if events in cand_thor and tx_hr happened on the same day
  group_by(PX_ID, unique_date) %>% 
  mutate(unique_event = str_c(unique_event, collapse = ",")) %>% 
  
  # removes redundant rows after combining events above
  group_by(PX_ID, unique_date) %>% 
  fill(WL_ORG:REC_MM_EQUIV_TX, .direction = "downup") %>% 
  distinct() %>% 
  
  # fills in missing values for each candidate, since all vars in cand_thor and
  # tx_hr do not have multiple values across time
  group_by(PX_ID) %>% 
  fill(WL_ORG:REC_MM_EQUIV_TX, .direction = "downup") %>%
  
  # arranges dataset for easy viewing
  arrange(PX_ID, unique_date) %>% 
  ungroup()
  
```

# 5. Pivot stathist_thor by date, then join with full_list_post

```{r pivot stathist_thor}

stathist_post <- stathist_post %>% 
  select(PX_ID, CANHX_BEGIN_DT, CANHX_END_DT, CANHX_STAT_CD, 
         CANHX_REASON_STAT_INACT) %>% 
  pivot_longer(cols = ends_with("DT"),
               names_to = "event", 
               values_to = "date", 
               values_drop_na = TRUE) %>%
  arrange(date) %>% 
  group_by(date) %>% 
  mutate(unique_date = date) %>%
  group_by(PX_ID, date) %>% 
  mutate(unique_event = str_c(event, collapse = ",")) %>% 
  pivot_wider(names_from = event, values_from = date) %>%
  arrange(PX_ID, unique_date) %>% 
  ungroup() %>%
  select(PX_ID, unique_event, unique_date, CANHX_STAT_CD, 
         CANHX_REASON_STAT_INACT)

full_list_post <- full_list_post %>% 
  
  # full join by common variables, thus no need for suffix
  full_join(stathist_post, by = c("PX_ID", "unique_date", "unique_event")) %>% 
  
  # combines events if events happened on the same day
  group_by(PX_ID, unique_date) %>%
  mutate(unique_event = str_c(unique_event, collapse = ",")) %>%

  # removes redundant rows after combining events above
  group_by(PX_ID, unique_date) %>%
  fill(WL_ORG:CANHX_REASON_STAT_INACT, .direction = "downup") %>%
  distinct() %>%

  # fills in missing status code for each candidate, but only fills down to 
  # preserve changes in status over time (similar/same mechanism as na.locf)
  group_by(PX_ID) %>%
  fill(CANHX_STAT_CD, .direction = "down") %>%
  
  # arranges dataset for easy viewing
  arrange(PX_ID, unique_date) %>% 
  ungroup()

```

# 4. Pivot justification forms by date, then join with full_list_post

```{r add just forms}

just_stat1_post <- just_stat1_post %>% 
  distinct(across(-JustId), .keep_all = TRUE) %>%
  mutate(stat1_criteria = case_when(
    CriteriaEcmoSupport == 1 ~ "Status 1: ECMO",
    CriteriaBivadSupport == 1 ~ "Status 1: BiVAD",
    CriteriaMcsdSupport == 1 ~ "Status 1: MCSD with ventricular arrhythmia",
    TRUE ~ "Status 1: Exception"),
    ChangeDt = ChangeDate) %>% 
  pivot_longer(cols = ends_with("Dt"),
               names_to = "event", 
               values_to = "date", 
               values_drop_na = TRUE) %>%
  arrange(date) %>% 
  group_by(date) %>% 
  mutate(unique_date = date) %>%
  group_by(PX_ID, date) %>% 
  mutate(unique_event = str_c(event, collapse = ",")) %>% 
  pivot_wider(names_from = event, values_from = date) %>%
  mutate(
    EcmoSystolicBloodPressure = case_when(!is.na(EcmoSystolicBloodPressureDt) ~
                                            EcmoSystolicBloodPressure),
    EcmoCardiacIndex = case_when(!is.na(EcmoCardiacIndexDt) ~
                                   EcmoCardiacIndex),
    EcmoCapWedgePressure = case_when(!is.na(EcmoCapWedgePressureDt) ~
                                   EcmoCapWedgePressure),
    EcmoWithoutHemoSbp = case_when(!is.na(EcmoWithoutHemoSbpDt) ~
                                   EcmoWithoutHemoSbp),
    EcmoWithoutHemoArtLac = case_when(!is.na(EcmoWithoutHemoArtLacDt) ~
                                   EcmoWithoutHemoArtLac),
    EcmoWithoutHemoAst = case_when(!is.na(EcmoWithoutHemoAstDt) ~
                                   EcmoWithoutHemoAst),
    EcmoWithoutHemoAlt = case_when(!is.na(EcmoWithoutHemoAltDt) ~
                                   EcmoWithoutHemoAlt)) %>% 
  arrange(PX_ID, unique_date) %>% 
  ungroup() %>%
  select(PX_ID, JustId, unique_event, unique_date,
         stat1_criteria, EcmoSystolicBloodPressure, EcmoCardiacIndex, 
         EcmoCapWedgePressure, EcmoWithoutHemoSbp, EcmoWithoutHemoArtLac, 
         EcmoWithoutHemoAst, EcmoWithoutHemoAlt)

just_stat2_post <- just_stat2_post %>% 
  distinct(across(-JustId), .keep_all = TRUE) %>%
  mutate(stat2_criteria = case_when(
    CriteriaLvadSupport == 1 ~ "Status 2: Non-dischargeable LVAD",
    CriteriaDurableDevSupport == 1 ~ "Status 2: Durable VAD",
    CriteriaMcsdMalfunction == 1 ~ "Status 2: MCSD malfunction",
    CriteriaMcsdEndovasSupp == 1 ~ "Status 2: Endovascular MCSD",
    CriteriaIabpSupport == 1 ~ "Status 2: IABP",
    CriteriaVentEpisode == 1 ~ "Status 2: Ventricular episodes",
    TRUE ~ "Status 2: Exception"),
    ChangeDt = ChangeDate) %>% 
  pivot_longer(cols = ends_with("Dt"),
               names_to = "event", 
               values_to = "date", 
               values_drop_na = TRUE) %>%
  arrange(date) %>% 
  group_by(date) %>% 
  mutate(unique_date = date) %>%
  group_by(PX_ID, date) %>% 
  mutate(unique_event = str_c(event, collapse = ",")) %>% 
  pivot_wider(names_from = event, values_from = date) %>%
  mutate(
    McsdCardiacIndex = case_when(!is.na(McsdCardiacIndexDt) ~ McsdCardiacIndex),
    McsdCapWedgePressure = case_when(!is.na(McsdCapWedgePressureDt) ~ 
                                       McsdCapWedgePressure),
    McsdSystolicBloodPressure = case_when(!is.na(McsdSystolicBloodPressureDt) ~ 
                                       McsdSystolicBloodPressure),
    McsdWithoutHemoSbp = case_when(!is.na(McsdWithoutHemoSbpDt) ~ 
                                       McsdWithoutHemoSbp),
    McsdWithoutHemoArtLac = case_when(!is.na(McsdWithoutHemoArtLacDt) ~ 
                                       McsdWithoutHemoArtLac),
    McsdWithoutHemoAst = case_when(!is.na(McsdWithoutHemoAstDt) ~ 
                                       McsdWithoutHemoAst),
    IabpCardiacIndex = case_when(!is.na(IabpCardiacIndexDt) ~ 
                                       IabpCardiacIndex),
    IabpCapWedgePressure = case_when(!is.na(IabpCapWedgePressureDt) ~ 
                                       IabpCapWedgePressure),
    IabpSystolicBloodPressure = case_when(!is.na(IabpSystolicBloodPressureDt) ~ 
                                       IabpSystolicBloodPressure),
    IabpWithoutHemoSbp = case_when(!is.na(IabpWithoutHemoSbpDt) ~ 
                                       IabpWithoutHemoSbp),
    IabpWithoutHemoArtLac = case_when(!is.na(IabpWithoutHemoArtLacDt) ~ 
                                       IabpWithoutHemoArtLac),
    IabpWithoutHemoAst = case_when(!is.na(IabpWithoutHemoAstDt) ~ 
                                       IabpWithoutHemoAst),
    IabpWithoutHemoAlt = case_when(!is.na(IabpWithoutHemoAltDt) ~ 
                                       IabpWithoutHemoAlt)) %>% 
  arrange(PX_ID, unique_date) %>% 
  ungroup() %>%
  select(PX_ID, JustId, unique_event, unique_date,
         stat2_criteria, McsdCardiacIndex, 
         McsdCapWedgePressure, McsdSystolicBloodPressure, McsdWithoutHemoSbp, 
         McsdWithoutHemoArtLac, McsdWithoutHemoAst, 
         IabpCardiacIndex, IabpCapWedgePressure, IabpSystolicBloodPressure,
         IabpWithoutHemoSbp, IabpWithoutHemoArtLac, IabpWithoutHemoAst,
         IabpWithoutHemoAlt)

just_stat3_post <- just_stat3_post %>% 
  distinct(across(-JustId), .keep_all = TRUE) %>%
  mutate(stat3_criteria = case_when(
    CriteriaLvadDiscSupport == 1 ~ "Status 3: Dischargeable LVAD discretionary time",
    CriteriaInotropeSupport == 1 ~ "Status 3: Inotropes with hemodynamic monitoring",
    CriteriaMcsdWithHemo == 1 ~ "Status 3: MCSD with hemolysis",
    CriteriaMcsdWithPump == 1 ~ "Status 3: MCSD with pump thrombosis",
    CriteriaMcsdWithRhf == 1 ~ "Status 3: MCSD with RHF",
    CriteriaMcsdInfection == 1 ~ "Status 3: MCSD with device infection",
    CriteriaMcsdMucosalBleed == 1 ~ "Status 3: MCSD with bleeding",
    CriteriaMcsdWithAI == 1 ~ "Status 3: MCSD with AI",
    CriteriaVaEcmoSupport == 1 ~ "Status 3: ECMO after 7 days",
    CriteriaLvadSupport == 1 ~ "Status 3: Non-dischargeable LVAD after 14 days",
    CriteriaPercuSupport == 1 ~ "Status 3: Endovascular MCSD after 14 days",
    CriteriaIabpSupport == 1 ~ "Status 3: IABP after 14 days",
    TRUE ~ "Status 3: Exception"),
    ChangeDt = ChangeDate) %>% 
  pivot_longer(cols = ends_with("Dt"),
               names_to = "event", 
               values_to = "date", 
               values_drop_na = TRUE) %>%
  arrange(date) %>% 
  group_by(date) %>% 
  mutate(unique_date = date) %>%
  group_by(PX_ID, date) %>% 
  mutate(unique_event = str_c(event, collapse = ",")) %>% 
  pivot_wider(names_from = event, values_from = date) %>%
  mutate(
    InoCardiacIndex = case_when(!is.na(InoCardiacIndexDt) ~ InoCardiacIndex),
    InoCapWedgePressure = case_when(!is.na(InoCapWedgePressureDt) ~ 
                                      InoCapWedgePressure),
    InoSysBloodPressure = case_when(!is.na(InoSysBloodPressureDt) ~ 
                                      InoSysBloodPressure),
    McsdWithRhfPcwp = case_when(!is.na(McsdWithRhfPcwpDt) ~ 
                                      McsdWithRhfPcwp),
    McsdWithRhfVenPressure = case_when(!is.na(McsdWithRhfVenPressureDt) ~ 
                                      McsdWithRhfVenPressure)) %>% 
  arrange(PX_ID, unique_date) %>% 
  ungroup() %>%
  select(PX_ID, JustId, unique_event, unique_date,
         stat3_criteria, InoCardiacIndex,
         InoCapWedgePressure, InoSysBloodPressure, McsdLactateDehydrogenase,
         McsdPlasmaFreeHemoglobin, McsdHemoglobinuria,
         McsdWithPumpTransIscAttack, McsdWithRhfPcwp, McsdWithRhfVenPressure, 
         MucosalBleedNumHosp)

just_stat4_post <- just_stat4_post %>%
  distinct(across(-JustId), .keep_all = TRUE) %>% 
  mutate(stat4_criteria = case_when(
    CriteriaLvadSupport == 1 ~ "Status 4: Dischargeable LVAD without discretionary time",
    CriteriaInotropeSupport == 1 ~ "Status 4: Inotropes without hemodynamic monitoring",
    CriteriaHeartDisease == 1 ~ "Status 4: Congenital heart disease",
    CriteriaIschemicHeart == 1 ~ "Status 4: Ischemic heart disease with intractable angina",
    CriteriaCardiomyopathy == 1 ~ "Status 4: Amyloidosis, HCM, or RCM",
    CriteriaRetransplant == 1 ~ "Status 4: Re-transplant",
    TRUE ~ "Status 4: Exception"),
    ChangeDt = ChangeDate) %>%
  pivot_longer(cols = ends_with("Dt"),
               names_to = "event", 
               values_to = "date", 
               values_drop_na = TRUE) %>%
  arrange(date) %>% 
  group_by(date) %>% 
  mutate(unique_date = date) %>%
  group_by(PX_ID, date) %>% 
  mutate(unique_event = str_c(event, collapse = ",")) %>% 
  pivot_wider(names_from = event, values_from = date) %>%
  mutate(
    InotropeCardiacIndex = case_when(!is.na(InotropeCardiacIndexDt) ~ 
                                       InotropeCardiacIndex),
    InotropePcwp = case_when(!is.na(InotropePcwpDt) ~ 
                                       InotropePcwp)) %>% 
  arrange(PX_ID, unique_date) %>% 
  ungroup() %>%
  select(PX_ID, JustId, unique_event, unique_date,
         stat4_criteria, InotropeCardiacIndex, InotropePcwp)

just_all_stat_post <- just_stat1_post %>% 
  full_join(just_stat2_post, by = c("PX_ID", "unique_event", "unique_date", "JustId")) %>%
  full_join(just_stat3_post, by = c("PX_ID", "unique_event", "unique_date", "JustId")) %>%
  full_join(just_stat4_post, by = c("PX_ID", "unique_event", "unique_date", "JustId")) %>% 
  
  mutate(status_criteria = coalesce(stat1_criteria,
                                    stat2_criteria,
                                    stat3_criteria,
                                    stat4_criteria)) %>%
  mutate(status_criteria =
           ifelse(is.na(status_criteria), "Status 6", status_criteria)) %>%
  select(-stat1_criteria, -stat2_criteria, -stat3_criteria, -stat4_criteria)
  
# full join on common variables
full_list_post <- full_list_post %>% 
  full_join(just_all_stat_post, by = c("PX_ID", "unique_event", "unique_date")) %>% 
  
  # justification forms have date-times instead of dates, so converting to date
  mutate(unique_date = floor_date(unique_date, unit = "day")) %>%
  
  # fills status criteria from justification form to all rows within each
  # group of PX_ID and JustId
  group_by(PX_ID, JustId) %>% 
  fill(status_criteria, .direction = "downup") %>% 
  ungroup() %>% 
  
  # # TODO: fix bug that does not combine all events (see PX_ID = 1238278, 1238293)
  # # combines events if events happened on the same day
  # group_by(PX_ID, unique_date) %>%
  # mutate(unique_event = str_c(unique_event, collapse = ",")) %>%
  # 
  # # removes redundant rows after combining events above
  # group_by(PX_ID, unique_date) %>%
  # fill(WL_ORG:InotropePcwp, .direction = "downup") %>%
  # distinct() %>%
  
  # arranges dataset by PX_ID and event date for easy viewing
  arrange(PX_ID, unique_date) %>% 
  ungroup()
```

# 7. Pivoting risk stratification data by date, then joining with full_list_post

```{r pivot risk strat data}
risk_strat_post <- risk_strat_post %>% 
  pivot_longer(cols = ends_with("Dt"),
               names_to = "event", 
               values_to = "date", 
               values_drop_na = TRUE) %>%
  
  group_by(date) %>% 
  mutate(unique_date = date, PX_ID = px_id) %>%
  group_by(PX_ID, date) %>% 
  mutate(unique_event = str_c(event, collapse = ",")) %>% 
  pivot_wider(names_from = event, values_from = date) %>% 
  mutate(
    CPTestMvo2 = case_when(!is.na(CPTestDt) ~ CPTestMvo2),
    CPTestRer = case_when(!is.na(CPTestDt) ~ CPTestRer),
    CPTestVeVco2 = case_when(!is.na(CPTestDt) ~ CPTestVeVco2),
    SenDataCpra = case_when(!is.na(SenDataDt) ~ SenDataCpra),
    SenDataMfiThreshold = case_when(!is.na(SenDataDt) ~ SenDataMfiThreshold),
    HemoObtainedOnSupport = case_when(!is.na(HemoDt) ~ HemoObtainedOnSupport),
    HemoSbp = case_when(!is.na(HemoDt) ~ HemoSbp),
    HemoDbp = case_when(!is.na(HemoDt) ~ HemoDbp),
    HemoRestingHeartRate = case_when(!is.na(HemoDt) ~ HemoRestingHeartRate),
    HemoCvp = case_when(!is.na(HemoDt) ~ HemoCvp),
    HemoPasp = case_when(!is.na(HemoDt) ~ HemoPasp),
    HemoPadp = case_when(!is.na(HemoDt) ~ HemoPadp),
    HemoMeanPressure = case_when(!is.na(HemoDt) ~ HemoMeanPressure),
    HemoPcwp = case_when(!is.na(HemoDt) ~ HemoPcwp),
    HemoLvedp = case_when(!is.na(HemoDt) ~ HemoLvedp),
    HemoCardiacOutput = case_when(!is.na(HemoDt) ~ HemoCardiacOutput),
    HemoCardiacIndex = case_when(!is.na(HemoDt) ~ HemoCardiacIndex),
    HemoSvo2 = case_when(!is.na(HemoDt) ~ HemoSvo2),
    HemoHemoglobin = case_when(!is.na(HemoDt) ~ HemoHemoglobin),
    VadLdhLevels = case_when(!is.na(VadLdhLevelsDt) ~ VadLdhLevels),
    VadPlasmaFreeHemo = case_when(!is.na(VadPlasmaFreeHemoDt) ~ VadPlasmaFreeHemo),
    HrSevFailSodium = case_when(!is.na(HrSevFailSodiumDt) ~ HrSevFailSodium),
    HrSevFailCreatinine = case_when(!is.na(HrSevFailCreatinineDt) ~ HrSevFailCreatinine),
    HrSevFailBun = case_when(!is.na(HrSevFailBunDt) ~ HrSevFailBun),
    HrSevFailAlbumin = case_when(!is.na(HrSevFailAlbuminDt) ~ HrSevFailAlbumin),
    HrSevFailAsparTrans = case_when(!is.na(HrSevFailAsparTransDt) ~ HrSevFailAsparTrans),
    HrSevFailBilirubin = case_when(!is.na(HrSevFailBilirubinDt) ~ HrSevFailBilirubin),
    HrSevFailArterialLact = case_when(!is.na(HrSevFailArterialLactDt) ~
                                        HrSevFailArterialLact),
    HrSevFailInr = case_when(!is.na(HrSevFailInrDt) ~ HrSevFailInr),
    HrSevFailInrAntiCoag = case_when(!is.na(HrSevFailInrDt) ~ HrSevFailInrAntiCoag),
    HrSevFailBnp = case_when(!is.na(HrSevFailBnpDt) ~ HrSevFailBnp)) %>%

  arrange(PX_ID, unique_date) %>% 
  ungroup() %>% 
  
  select(PX_ID, RiskStratId, ChangeDate, unique_date, unique_event, 
         CandHistNumSternotomies, CandHistStroke, CandHistThromb,
         CandHistNumHospAdmn, CurrTherOnLoopDiuretic, CurrTherVasoactiveSupport,
         CurrTherAntiArrhythmics, CurrTherPulVas, CurrTherOnDialysis,
         CurrTherMechVent, CPTestMvo2, CPTestRer, CPTestVeVco2, SenDataCpra, 
         SenDataMfiThreshold, HemoObtainedOnSupport, HemoSbp, HemoDbp,
         HemoRestingHeartRate, HemoCvp, HemoPasp, HemoPadp, HemoMeanPressure, 
         HemoPcwp, HemoLvedp, HemoCardiacOutput, HemoCardiacIndex, HemoSvo2,
         HemoHemoglobin, VadLdhLevels, VadPlasmaFreeHemo, VadHemoglobinuria, 
         HrSevFailSodium, HrSevFailCreatinine, HrSevFailBun, HrSevFailAlbumin, 
         HrSevFailAsparTrans, HrSevFailBilirubin, HrSevFailArterialLact, 
         HrSevFailInr, HrSevFailInrAntiCoag, HrSevFailBnp)  

full_list_post <- full_list_post %>% 
  
  # full join by common variables, thus no need for suffix
  full_join(risk_strat_post, by = c("PX_ID", "unique_date", "unique_event")) %>% 
  
  # # combines events if events in cand_thor and tx_hr happened on the same day
  # group_by(PX_ID, unique_date) %>% 
  # mutate(unique_event = str_c(unique_event, collapse = ",")) %>% 
  
  # # removes redundant rows after combining events above
  # group_by(PX_ID, unique_date) %>% 
  # fill(WL_ORG:REC_MM_EQUIV_TX, .direction = "downup") %>% 
  # distinct() %>% 
  
  # arranges dataset for easy viewing
  arrange(PX_ID, unique_date) %>% 
  ungroup()

```

# 8. Calculating number of days between each observation in full_list_post, by PX_ID

```{r}

full_list_post <- full_list_post %>%
  ungroup() %>% 
  arrange(PX_ID, unique_date)

for (i in 2:nrow(full_list_post)) {
  if (full_list_post$PX_ID[[i]] == 
      full_list_post$PX_ID[[i-1]]) {
    
    full_list_post$t_stop[[i-1]] = 
      full_list_post$unique_date[[i]] - 
      full_list_post$unique_date[[i-1]] +
      full_list_post$t_start[[i-1]]
    
    full_list_post$t_start[[i]] = full_list_post$t_stop[[i-1]]
    
  } else {
    
    full_list_post$t_stop[[i-1]] = 
      full_list_post$t_start[[i-1]]
    
    full_list_post$t_start[[i]] = 0
      
  }
}

```
