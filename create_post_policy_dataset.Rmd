---
title: "create_post_policy_dataset"
author: "Kevin Lazenby"
date: "12/21/2021"
output:
  pdf_document:
    toc: yes
    toc_depth: '2'
  html_notebook:
    theme: journal
    toc: yes
    toc_depth: 2
    toc_float: yes
---

# Setup

```{r setup, include=FALSE}

library(knitr)
opts_chunk$set(comment = NA, prompt = FALSE, cache = FALSE, echo = TRUE,
                      results = "asis")

library(tidyverse)
library(haven)
library(rmdformats)
library(dplyr)
library(tidyr)
library(ggpubr)
library(here)
library(readr)
library(lubridate)
library(boxr)

here::i_am("create_post_policy_dataset.Rmd")
```

# 1. Import data sets from SRTR

```{r}

curr_data_release <- "pubsaf2103"

cand_thor <- read_sas(here(curr_data_release, "cand_thor.sas7bdat"), NULL) %>%  
  zap_formats() %>% zap_labels()

cand_thor_selected_vars <- c("PX_ID", "WL_ORG", "CAN_GENDER", "CAN_ABO", "CAN_RACE",
                             "PERS_SSA_DEATH_DT", "PERS_OPTN_DEATH_DT", 
                             "PERS_RESTRICT_DEATH_DT", "CAN_LISTING_DT", "CAN_REM_DT",
                             "CAN_REM_CD", "CAN_DGN", "CAN_ECMO", "CAN_VENTILATOR",
                             "CAN_IABP", "CAN_IV_INOTROP", "CAN_VAD_TY", "CAN_VAD1",
                             "CAN_PRIMARY_PAY", "CAN_HGT_CM", "CAN_WGT_KG", "CAN_BMI",
                             "CAN_DIAB_TY", "CAN_DIAL", "CAN_DRUG_TREAT_HYPERTEN",
                             "CAN_CEREB_VASC", "CAN_PERIPH_VASC",
                             "CAN_MOST_RECENT_CREAT", "CAN_TOT_ALBUMIN", 
                             "CAN_ANTI_ARRYTHM", "CAN_IMPLANT_DEFIB", 
                             "CAN_PULM_ART_MEAN", "CAN_PCW_MEAN", 
                             "CAN_CARDIAC_OUTPUT", "CAN_HIST_CIGARETTE",
                             "CAN_OTHER_TOBACCO_USE", "CAN_MALIG",
                             "CAN_AGE_IN_MONTHS_AT_LISTING", "CAN_LAST_ACT_STAT_DT",
                             "CAN_INIT_STAT", "CAN_ANGINA", "CAN_ANGINA_CAD",
                             "CAN_PEPTIC_ULCER", "CAN_PULM_EMBOL", "CAN_EXERCISE_O2")

stat_just_hr1a <- read_sas(here(curr_data_release, "statjust_hr1a.sas7bdat"), NULL) %>%  
  zap_formats() %>% zap_labels()

stat_just_hr1b <- read_sas(here(curr_data_release, "statjust_hr1b.sas7bdat"), NULL) %>%  
  zap_formats() %>% zap_labels()

just_form_hr <- read_sas(here(curr_data_release, "JustFormHR.sas7bdat"), NULL) %>%  
  zap_formats() %>% zap_labels()

just_form_hr_stat1 <- 
  read_sas(here(curr_data_release, "JustFormHRStat1.sas7bdat"), NULL) %>%  
  zap_formats() %>% zap_labels()

just_form_hr_stat2 <- 
  read_sas(here(curr_data_release, "JustFormHRStat2.sas7bdat"), NULL) %>%  
  zap_formats() %>% zap_labels()

just_form_hr_stat3 <- 
  read_sas(here(curr_data_release, "JustFormHRStat3.sas7bdat"), NULL) %>%  
  zap_formats() %>% zap_labels()

just_form_hr_stat4 <- 
  read_sas(here(curr_data_release, "JustFormHRStat4.sas7bdat"), NULL) %>%  
  zap_formats() %>% zap_labels()

risk_strat_data_hr <- 
  read_sas(here(curr_data_release, "RiskStratDataHR.sas7bdat"), NULL) %>%  
  zap_formats() %>% zap_labels()

just_form_hr_data_link <- 
  read_sas(here(curr_data_release, "JustFormHRDataLink.sas7bdat"), NULL) %>%  
  zap_formats() %>% zap_labels()

column_descriptions <- 
  read_sas(here(curr_data_release, "ColumnDescriptions.sas7bdat"), NULL) %>%  
  zap_formats() %>% zap_labels()

table_descriptions <- 
  read_sas(here(curr_data_release, "TableDescriptions.sas7bdat"), NULL) %>%  
  zap_formats() %>% zap_labels()

stathist_thor <- 
  read_sas(here(curr_data_release, "stathist_thor.sas7bdat"), NULL) %>%  
  zap_formats() %>% zap_labels()

status_just_episode <- 
  read_sas(here(curr_data_release, "StatusJustEpisode.sas7bdat"), NULL) %>%
  zap_formats() %>% zap_labels()

thor_support_device <- 
  read_sas(here(curr_data_release, "ThorSupportDevice.sas7bdat"), NULL) %>% 
  zap_formats() %>% zap_labels()

tx_hr <- read_sas(here(curr_data_release, "tx_hr.sas7bdat"), NULL) %>%  
  zap_formats() %>% zap_labels()
```

# 2. Link data sets using JustId, WlregAuditId, and PX_ID
#     a. common linking variable after this block is PX_ID

```{r link data sets}

just_form_hr_data_link <- just_form_hr_data_link %>% 
  left_join(risk_strat_data_hr %>%
              select(px_id, WlregAuditId), by = "WlregAuditId") %>% 
  mutate(PX_ID = px_id) %>% select(-px_id)

just_form_hr <- just_form_hr %>% 
  left_join(just_form_hr_data_link %>% select(JustId, PX_ID), by = "JustId")

just_form_hr_stat1 <- just_form_hr_stat1 %>% 
  left_join(just_form_hr_data_link %>% select(JustId, PX_ID), by = "JustId")

just_form_hr_stat2 <- just_form_hr_stat2 %>% 
  left_join(just_form_hr_data_link %>% select(JustId, PX_ID), by = "JustId")

just_form_hr_stat3 <- just_form_hr_stat3 %>% 
  left_join(just_form_hr_data_link %>% select(JustId, PX_ID), by = "JustId")

just_form_hr_stat4 <- just_form_hr_stat4 %>% 
  left_join(just_form_hr_data_link %>% select(JustId, PX_ID), by = "JustId")

```


# 3. Tidy input datasets
#     a. Filter out candidates listed before new policy implementation
#     b. Filter in adult, heart-only transplant candidates
#     c. Remove variables which are missing or irrelevant

```{r}
policy_switch_date <- mdy("10/18/2018")

multi_organ_recipients <- tx_hr %>% 
  filter(REC_TX_TY == 2 | REC_TX_TY == 4) %>% 
	select(PX_ID, REC_TX_TY)

# filter candidates based on inclusion/exclusion criteria to create initial listing state
init_list_post <- cand_thor %>% 
  filter(CAN_LISTING_DT >= policy_switch_date) %>% 
  filter(WL_ORG == "HR") %>% 
  filter(CAN_INIT_STAT != 2150) %>% 
  filter(CAN_AGE_AT_LISTING > 17) %>% 
  filter(!(PX_ID %in% multi_organ_recipients$PX_ID))

# risk stratification data from post-policy era
risk_strat_post <- risk_strat_data_hr %>% 
  mutate(PX_ID = px_id) %>% select(-px_id) %>%
  filter(PX_ID %in% init_list_post$PX_ID)

# status history file from post-policy era
stathist_post <- stathist_thor %>% filter(PX_ID %in% init_list_post$PX_ID)

# justification forms from post-policy era
just_form_post <- just_form_hr %>% filter(PX_ID %in% init_list_post$PX_ID)

# data linking dataframe from post-policy era
data_link_post <- just_form_hr_data_link %>% filter(PX_ID %in% init_list_post$PX_ID)

# Status 1 justification forms from post-policy era
just_stat1_post <- just_form_hr_stat1 %>% filter(PX_ID %in% init_list_post$PX_ID)

# Status 2 justification forms from post-policy era
just_stat2_post <- just_form_hr_stat2 %>% filter(PX_ID %in% init_list_post$PX_ID)

# Status 3 justification forms from post-policy era
just_stat3_post <- just_form_hr_stat3 %>% filter(PX_ID %in% init_list_post$PX_ID)

# Status 4 justification forms from post-policy era
just_stat4_post <- just_form_hr_stat4 %>% filter(PX_ID %in% init_list_post$PX_ID)

# this line selects the 46 variables in cand_thor currently used in analysis
init_list_post <- init_list_post %>% select(all_of(cand_thor_selected_vars))

missing_data_check <- tibble(
  pct_missing = vector(mode = "double", length = ncol(init_list_post)),
  var_names = colnames(init_list_post))

for (i in 1:ncol(init_list_post)) {
  
  missing_data_check$pct_missing[i] <-
    sum(is.na(init_list_post[, i])) / nrow(init_list_post)
}

missing_data_check <- missing_data_check %>% 
  filter(pct_missing == 1) %>% 
  arrange(desc(pct_missing))

# this line removes 4 variables from init_list_post which are completely missing
# Variable names: CAN_ANGINA, CAN_ANGINA_CAD, CAN_PEPTIC_ULCER, CAN_TOT_ALBUMIN
init_list_post <- init_list_post %>% select(-missing_data_check$var_names)
```

# 4. Add initial justification form for each candidate to init_list_post

```{r}
init_just_forms <- just_form_post %>% 
  group_by(PX_ID) %>% 
  slice_min(FormAddDt, with_ties = FALSE) %>% 
  ungroup()

just_stat1_post <- just_stat1_post %>% 
  mutate(stat1_criteria = case_when(
    CriteriaEcmoSupport == 1 ~ "Status 1: ECMO",
    CriteriaBivadSupport == 1 ~ "Status 1: BiVAD",
    CriteriaMcsdSupport == 1 ~ "Status 1: MCSD with ventricular arrhythmia",
    TRUE ~ "Status 1: Exception"))

init_list_post <- init_list_post %>% 
  left_join(just_stat1_post %>% 
              filter(PX_ID %in% init_just_forms$PX_ID) %>%
              group_by(PX_ID) %>% 
              slice_min(ChangeDate, with_ties = FALSE) %>% 
              ungroup() %>% 
              select(stat1_criteria, EcmoSystolicBloodPressure, 
                     EcmoCardiacIndex, EcmoCapWedgePressure, EcmoWithoutHemoSbp,
                     EcmoWithoutHemoArtLac, EcmoWithoutHemoAst,
                     EcmoWithoutHemoAlt, PX_ID), by = "PX_ID")

just_stat2_post <- just_stat2_post %>% 
  mutate(stat2_criteria = case_when(
    CriteriaLvadSupport == 1 ~ "Status 2: Non-dischargeable LVAD",
    CriteriaDurableDevSupport == 1 ~ "Status 2: Durable VAD",
    CriteriaMcsdMalfunction == 1 ~ "Status 2: MCSD malfunction",
    CriteriaMcsdEndovasSupp == 1 ~ "Status 2: Endovascular MCSD",
    CriteriaIabpSupport == 1 ~ "Status 2: IABP",
    CriteriaVentEpisode == 1 ~ "Status 2: Ventricular episodes",
    TRUE ~ "Status 2: Exception"))

init_list_post <- init_list_post %>% 
  left_join(just_stat2_post %>% 
              filter(PX_ID %in% init_just_forms$PX_ID) %>%
              group_by(PX_ID) %>% 
              slice_min(ChangeDate, with_ties = FALSE) %>% 
              ungroup() %>% 
              select(stat2_criteria, McsdCardiacIndex, McsdCapWedgePressure,
                     McsdSystolicBloodPressure, McsdWithoutHemoSbp,
                     McsdWithoutHemoArtLac, McsdWithoutHemoAst,
                     McsdWithoutHemoAlt, IabpCardiacIndex, IabpCapWedgePressure,
                     IabpSystolicBloodPressure, IabpWithoutHemoSbp, 
                     IabpWithoutHemoArtLac, IabpWithoutHemoAst, 
                     IabpWithoutHemoAlt, PX_ID), 
            by = "PX_ID")

just_stat3_post <- just_stat3_post %>% 
  mutate(stat3_criteria = case_when(
    CriteriaLvadDiscSupport == 1 ~ "Status 3: Dischargeable LVAD discretionary time",
    CriteriaInotropeSupport == 1 ~ "Status 3: Inotropes with hemodynamic monitoring",
    CriteriaMcsdWithHemo == 1 ~ "Status 3: MCSD with hemolysis",
    CriteriaMcsdWithPump == 1 ~ "Status 3: MCSD with pump thrombosis",
    CriteriaMcsdWithRhf == 1 ~ "Status 3: MCSD with RHF",
    CriteriaMcsdInfection == 1 ~ "Status 3: MCSD with device infection",
    CriteriaMcsdMucosalBleed == 1 ~ "Status 3: MCSD with bleeding",
    CriteriaMcsdWithAI == 1 ~ "Status 3: MCSD with AI",
    CriteriaVaEcmoSupport == 1 ~ "Status 3: ECMO after 7 days",
    CriteriaLvadSupport == 1 ~ "Status 3: Non-dischargeable LVAD after 14 days",
    CriteriaPercuSupport == 1 ~ "Status 3: Endovascular MCSD after 14 days",
    CriteriaIabpSupport == 1 ~ "Status 3: IABP after 14 days",
    TRUE ~ "Status 3: Exception"))

init_list_post <- init_list_post %>% 
  left_join(just_stat3_post %>% 
              filter(PX_ID %in% init_just_forms$PX_ID) %>%
              group_by(PX_ID) %>% 
              slice_min(ChangeDate, with_ties = FALSE) %>% 
              ungroup() %>% 
              select(stat3_criteria, InoCardiacIndex, InoCapWedgePressure,
                     InoSysBloodPressure, McsdLactateDehydrogenase,
                     McsdPlasmaFreeHemoglobin, McsdHemoglobinuria,
                     McsdWithPumpTransIscAttack, McsdWithRhfPcwp,
                     McsdWithRhfVenPressure, MucosalBleedNumHosp, PX_ID), 
            by = "PX_ID")

just_stat4_post <- just_stat4_post %>% 
  mutate(stat4_criteria = case_when(
    CriteriaLvadSupport == 1 ~ "Status 4: Dischargeable LVAD without discretionary time",
    CriteriaInotropeSupport == 1 ~ "Status 4: Inotropes without hemodynamic monitoring",
    CriteriaHeartDisease == 1 ~ "Status 4: Congenital heart disease",
    CriteriaIschemicHeart == 1 ~ "Status 4: Ischemic heart disease with intractable angina",
    CriteriaCardiomyopathy == 1 ~ "Status 4: Amyloidosis, HCM, or RCM",
    CriteriaRetransplant == 1 ~ "Status 4: Re-transplant",
    TRUE ~ "Status 4: Exception"))

init_list_post <- init_list_post %>% 
  left_join(just_stat4_post %>% 
              filter(PX_ID %in% init_just_forms$PX_ID) %>%
              group_by(PX_ID) %>% 
              slice_min(ChangeDate, with_ties = FALSE) %>% 
              ungroup() %>% 
              select(stat4_criteria, InotropeCardiacIndex, InotropePcwp, PX_ID),
            by = "PX_ID")

init_list_post <- init_list_post %>% 
  mutate(status_criteria = coalesce(stat1_criteria, 
                                    stat2_criteria, 
                                    stat3_criteria, 
                                    stat4_criteria)) %>%
  mutate(status_criteria = 
           ifelse(is.na(status_criteria), "Status 6", status_criteria)) %>% 
  select(-stat1_criteria, -stat2_criteria, -stat3_criteria, -stat4_criteria)
```

# 5. Add first risk stratification datum for each candidate to init_list_post

```{r}
init_risk_strat_data <- risk_strat_post %>% 
  group_by(PX_ID) %>% 
  slice_min(ChangeDate, with_ties = FALSE) %>% 
  ungroup()

init_list_post <- init_list_post %>% 
  left_join(risk_strat_post %>% 
              filter(PX_ID %in% init_risk_strat_data$PX_ID) %>%
              group_by(PX_ID) %>% 
              slice_min(ChangeDate, with_ties = FALSE) %>% 
              ungroup() %>% 
              select(CandHistStroke, CandHistThromb, CPTestMvo2, CPTestRer, 
                     CPTestVeVco2, SenDataCpra, SenDataMfiThreshold, HemoSbp, 
                     HemoDbp, HemoRestingHeartRate, HemoCvp, HemoPasp, HemoPadp,
                     HemoMeanPressure, HemoPcwp, HemoLvedp, HemoCardiacOutput, 
                     HemoCardiacIndex, HemoSvo2, HemoHemoglobin, VadLdhLevels, 
                     VadPlasmaFreeHemo, VadHemoglobinuria, HrSevFailSodium, 
                     HrSevFailCreatinine, HrSevFailBun, HrSevFailAlbumin, 
                     HrSevFailAsparTrans, HrSevFailBilirubin, 
                     HrSevFailArterialLact, HrSevFailInr, HrSevFailBnp, PX_ID), 
            by = "PX_ID")
```

# 6. Write out csv of initial listing state during post-policy era

```{r}
# not run
# write_csv(init_list_post, file = "initial_listing_state.csv")
```

# TODO 7. Add in tx_hr data from time of transplant

# 8. Reshaping risk stratification data to include rows by unique observation date

```{r}
risk_strat_data_hr_long <- risk_strat_data_hr %>% 
  pivot_longer(cols = ends_with("Dt"),
               names_to = "event", 
               values_to = "date", 
               values_drop_na = TRUE) %>%
  arrange(date)

risk_strat_data_hr_wide <- risk_strat_data_hr_long %>%
  group_by(date) %>% 
  mutate(unique_date = date) %>% 
  pivot_wider(names_from = event, values_from = date) %>% 
  mutate(
    CPTestMvo2 = case_when(!is.na(CPTestDt) ~ CPTestMvo2),
    CPTestRer = case_when(!is.na(CPTestDt) ~ CPTestRer),
    CPTestVeVco2 = case_when(!is.na(CPTestDt) ~ CPTestVeVco2),
    SenDataCpra = case_when(!is.na(SenDataDt) ~ SenDataCpra),
    SenDataMfiThreshold = case_when(!is.na(SenDataDt) ~ SenDataMfiThreshold),
    HemoObtainedOnSupport = case_when(!is.na(HemoDt) ~ HemoObtainedOnSupport),
    HemoSbp = case_when(!is.na(HemoDt) ~ HemoSbp),
    HemoDbp = case_when(!is.na(HemoDt) ~ HemoDbp),
    HemoRestingHeartRate = case_when(!is.na(HemoDt) ~ HemoRestingHeartRate),
    HemoCvp = case_when(!is.na(HemoDt) ~ HemoCvp),
    HemoPasp = case_when(!is.na(HemoDt) ~ HemoPasp),
    HemoPadp = case_when(!is.na(HemoDt) ~ HemoPadp),
    HemoMeanPressure = case_when(!is.na(HemoDt) ~ HemoMeanPressure),
    HemoPcwp = case_when(!is.na(HemoDt) ~ HemoPcwp),
    HemoLvedp = case_when(!is.na(HemoDt) ~ HemoLvedp),
    HemoCardiacOutput = case_when(!is.na(HemoDt) ~ HemoCardiacOutput),
    HemoCardiacIndex = case_when(!is.na(HemoDt) ~ HemoCardiacIndex),
    HemoSvo2 = case_when(!is.na(HemoDt) ~ HemoSvo2),
    HemoHemoglobin = case_when(!is.na(HemoDt) ~ HemoHemoglobin),
    VadLdhLevels = case_when(!is.na(VadLdhLevelsDt) ~ VadLdhLevels),
    VadPlasmaFreeHemo = case_when(!is.na(VadPlasmaFreeHemoDt) ~ VadPlasmaFreeHemo),
    HrSevFailSodium = case_when(!is.na(HrSevFailSodiumDt) ~ HrSevFailSodium),
    HrSevFailCreatinine = case_when(!is.na(HrSevFailCreatinineDt) ~ HrSevFailCreatinine),
    HrSevFailBun = case_when(!is.na(HrSevFailBunDt) ~ HrSevFailBun),
    HrSevFailAlbumin = case_when(!is.na(HrSevFailAlbuminDt) ~ HrSevFailAlbumin),
    HrSevFailAsparTrans = case_when(!is.na(HrSevFailAsparTransDt) ~ HrSevFailAsparTrans),
    HrSevFailBilirubin = case_when(!is.na(HrSevFailBilirubinDt) ~ HrSevFailBilirubin),
    HrSevFailArterialLact = case_when(!is.na(HrSevFailArterialLactDt) ~
                                        HrSevFailArterialLact),
    HrSevFailInr = case_when(!is.na(HrSevFailInrDt) ~ HrSevFailInr),
    HrSevFailInrAntiCoag = case_when(!is.na(HrSevFailInrDt) ~ HrSevFailInrAntiCoag),
    HrSevFailBnp = case_when(!is.na(HrSevFailBnpDt) ~ HrSevFailBnp),
    PX_ID = px_id) %>% 
  
  select(CandHistStroke, CandHistThromb, CPTestDt, CPTestMvo2, CPTestRer, 
                     CPTestVeVco2, SenDataDt, SenDataCpra, SenDataMfiThreshold, HemoDt, HemoObtainedOnSupport, HemoSbp,
                     HemoDbp, HemoRestingHeartRate, HemoCvp, HemoPasp, HemoPadp,
                     HemoMeanPressure, HemoPcwp, HemoLvedp, HemoCardiacOutput, 
                     HemoCardiacIndex, HemoSvo2, HemoHemoglobin, VadLdhLevels, VadLdhLevelsDt,
                     VadPlasmaFreeHemo, VadPlasmaFreeHemoDt, VadHemoglobinuria, HrSevFailSodium, HrSevFailSodiumDt,
                     HrSevFailCreatinine, HrSevFailCreatinineDt, HrSevFailBun, HrSevFailBunDt, HrSevFailAlbumin, HrSevFailAlbuminDt,
                     HrSevFailAsparTrans, HrSevFailAsparTransDt, HrSevFailBilirubin, HrSevFailBilirubinDt,
                     HrSevFailArterialLact, HrSevFailArterialLactDt, HrSevFailInr, HrSevFailInrDt, HrSevFailInrAntiCoag, HrSevFailBnp, HrSevFailBnpDt, PX_ID)
    
    
```
