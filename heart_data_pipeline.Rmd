---
title: "heart_data_pipeline"
author: "Kevin Lazenby"
date: "12/21/2021"
output:
  pdf_document:
    toc: yes
    toc_depth: '2'
  html_notebook:
    theme: journal
    toc: yes
    toc_depth: 2
    toc_float: yes
---

# Setup

```{r setup, include=FALSE}

library(knitr)
opts_chunk$set(comment = NA, prompt = FALSE, cache = FALSE, echo = TRUE,
                      results = "asis")

library(tidyverse)
library(haven)
library(rmdformats)
library(dplyr)
library(tidyr)
library(ggpubr)
library(here)
library(readr)
library(lubridate)
# library(boxr)
library(zoo)
library(labelled)

here::i_am("heart_data_pipeline.Rmd")
```

# 1. Import data sets from SRTR

```{r load data}
start_time <- Sys.time()

# change this variable to load in a different release of the SAF
curr_data_release <- "pubsaf2303"

cand_thor <- read_sas(here(curr_data_release, "cand_thor.sas7bdat"), NULL) %>%  
  zap_formats() %>% zap_labels()

tx_hr <- read_sas(here(curr_data_release, "tx_hr.sas7bdat"), NULL) %>%  
  zap_formats() %>% zap_labels()

stathist_thor <- 
  read_sas(here(curr_data_release, "stathist_thor.sas7bdat"), NULL) %>%  
  zap_formats() %>% zap_labels()

stat_just_hr1a <- read_sas(here(curr_data_release, "statjust_hr1a.sas7bdat"), NULL) %>%  
  zap_formats() %>% zap_labels()

stat_just_hr1b <- read_sas(here(curr_data_release, "statjust_hr1b.sas7bdat"), NULL) %>%  
  zap_formats() %>% zap_labels()

just_form_hr <- read_sas(here(curr_data_release, "JustFormHR.sas7bdat"), NULL) %>%  
  zap_formats() %>% zap_labels()

just_form_hr_data_link <- 
  read_sas(here(curr_data_release, "JustFormHRDataLink.sas7bdat"), NULL) %>%  
  zap_formats() %>% zap_labels()

just_form_hr_stat1 <- 
  read_sas(here(curr_data_release, "JustFormHRStat1.sas7bdat"), NULL) %>%  
  zap_formats() %>% zap_labels()

just_form_hr_stat2 <- 
  read_sas(here(curr_data_release, "JustFormHRStat2.sas7bdat"), NULL) %>%  
  zap_formats() %>% zap_labels()

just_form_hr_stat3 <- 
  read_sas(here(curr_data_release, "JustFormHRStat3.sas7bdat"), NULL) %>%  
  zap_formats() %>% zap_labels()

just_form_hr_stat4 <- 
  read_sas(here(curr_data_release, "JustFormHRStat4.sas7bdat"), NULL) %>%  
  zap_formats() %>% zap_labels()

risk_strat_data_hr <- 
  read_sas(here(curr_data_release, "RiskStratDataHR.sas7bdat"), NULL) %>%  
  zap_formats() %>% zap_labels()

status_just_episode <- 
  read_sas(here(curr_data_release, "StatusJustEpisode.sas7bdat"), NULL) %>%
  zap_formats() %>% zap_labels()

thor_support_device <- 
  read_sas(here(curr_data_release, "ThorSupportDevice.sas7bdat"), NULL) %>% 
  zap_formats() %>% zap_labels()

column_descriptions <- 
  read_sas(here(curr_data_release, "ColumnDescriptions.sas7bdat"), NULL) %>%  
  zap_formats() %>% zap_labels()

table_descriptions <- 
  read_sas(here(curr_data_release, "TableDescriptions.sas7bdat"), NULL) %>%  
  zap_formats() %>% zap_labels()
```

# 2. Link data sets using JustId, WlregAuditId, and PX_ID

```{r link data sets}

risk_strat_data_hr <- risk_strat_data_hr %>% 
  mutate(ChangeDt = floor_date(ChangeDate, unit = "day")) %>%
  select(-ChangeDate) %>% 
  full_join(just_form_hr_data_link %>%
              select(-ChangeDate, -InitialFormJustId), by = "WlregAuditId") %>% 
  mutate(PX_ID = px_id) %>% 
  select(-px_id) %>%
  
  # removes entries that have valid WlregAuditId but missing JustId
  filter(!is.na(JustId)) %>%
  
  # there are instances in which two just. forms were submitted on the same day for a
  # single PX_ID. The time step in this process is one day, so these are removed
  group_by(PX_ID, ChangeDt) %>% slice_max(JustId) %>% 
  ungroup() %>% 
  
  select(-RiskStratId, -WlregAuditId, -ChangeUserId, -ChangeRequestorId,
         -HemoDataObtained, -HemoDataObtainedOther, -HemoPcwpOrLvedp) %>% 
  select(-(ends_with("St"))) %>% 
  select(-(starts_with("CandHist"))) %>%
  select(-(starts_with("SenData"))) %>%
  # select(-(starts_with("CurrTher"))) %>%
  # select(-(ends_with("Type"))) %>%
  select(-(ends_with("Perf"))) %>%
  relocate(ChangeDt:PX_ID)

# right_join to filter out erroneous forms, as above
just_form_hr_data_link <- just_form_hr_data_link %>%
  select(-ChangeDate) %>% 
  right_join(risk_strat_data_hr %>% 
              select(ChangeDt, JustId, PX_ID), by = "JustId")

# right_join to filter out erroneous forms, as above
just_form_hr <- just_form_hr %>% 
  select(JustId, RequestedCandStatCd, RequestedCandStat_descrip,
         ExtensionNumber, Exception, ThorSupportDevicePrimary,
         ThorSupportDeviceSecondary, descrip, AdmittedToHospital) %>%
  mutate(listing_description = descrip) %>% 
  select(-descrip) %>% 
  right_join(just_form_hr_data_link %>% 
              select(-WlregAuditId, -InitialFormJustId), by = "JustId")

  # status_just_episode provides same info as stathist_thor, so not including it
  # # join status episode information by JustId
  # full_join(status_just_episode %>% select(JustId:EndDate), by = "JustId")

# thor_support_device seems to include many duplicates, include at your own risk
# thor_support_device <- thor_support_device %>%
# 
#   select(DeviceId, VadBrandId, TahBrandId, PercuBrandId, ImplantDt) %>%
# 
#   # join device information by DeviceId
#   left_join(just_form_hr %>% select(ThorSupportDevicePrimary, PX_ID),
#             by = c("DeviceId" = "ThorSupportDevicePrimary")) %>%
#   select(-DeviceId) %>%
#   distinct(.keep_all = TRUE)
#   
#   
#   # can pipe in this code to include secondary VAD info from thor_support_device
#   # left_join(just_form_hr %>% select(ThorSupportDeviceSecondary, PX_ID),
#   #           by = c("DeviceId" = "ThorSupportDeviceSecondary"),
#   #           suffix = c(".primary", ".secondary"))

just_form_hr <- just_form_hr %>% 
  select(-ThorSupportDevicePrimary, -ThorSupportDeviceSecondary)

just_form_hr_stat1 <- just_form_hr_stat1 %>%
  select(-ChangeDate) %>% 
  left_join(just_form_hr_data_link %>% 
              select(JustId, PX_ID, ChangeDt), by = "JustId")

just_form_hr_stat2 <- just_form_hr_stat2 %>% 
  select(-ChangeDate) %>%
  left_join(just_form_hr_data_link %>% 
              select(JustId, PX_ID, ChangeDt), by = "JustId")

just_form_hr_stat3 <- just_form_hr_stat3 %>% 
  select(-ChangeDate) %>%
  left_join(just_form_hr_data_link %>%
              select(JustId, PX_ID, ChangeDt), by = "JustId")

just_form_hr_stat4 <- just_form_hr_stat4 %>% 
  select(-ChangeDate) %>%
  left_join(just_form_hr_data_link %>% 
              select(JustId, PX_ID, ChangeDt), by = "JustId")

```

# 3. Tidy input datasets
#     a. Filter out candidates listed before filter date
#     b. Filter out pediatric transplant candidates
#     c. Filter out lung-only transplant candidates

```{r apply exclusion criteria}

# change these variables to customize inclusion criteria
filter_date_start <- mdy("10-18-2018")
filter_date_end <- mdy("03-01-2022")
include_multi_organ_recipients <- TRUE
missingness_threshold <- 1

# filter candidates based on inclusion/exclusion criteria 
cand_list <- cand_thor %>% 
  
  # Remove recipients listed prior to policy change
  filter(CAN_LISTING_DT >= filter_date_start) %>%
  
  # Remove recipients transplanted after March 1, 2022 (insufficient follow-up)
  filter(REC_TX_DT <= filter_date_end) %>% 
  
  # Remove lung-only recipients
  filter(WL_ORG != "LU") %>% 
  
  # Remove recipients who were < 18 yrs old at listing
  filter((CAN_AGE_IN_MONTHS_AT_LISTING / 12) >= 18)

if (include_multi_organ_recipients == FALSE) {
  multi_organ_recipients <- tx_hr %>% 
  filter(REC_TX_TY == 2 | REC_TX_TY == 4) %>% 
	select(PX_ID, REC_TX_TY)
  
  cand_list <- cand_list %>% 
    filter(CAN_INIT_STAT != 2150) %>% 
    filter(!(PX_ID %in% multi_organ_recipients$PX_ID))
}

# filter tx_hr
tx_list <- tx_hr %>% filter(PX_ID %in% cand_list$PX_ID)

# filter risk stratification data
risk_strat <- risk_strat_data_hr %>%
  filter(PX_ID %in% cand_list$PX_ID)

# filter status history file
stathist <- stathist_thor %>% filter(PX_ID %in% cand_list$PX_ID)

# filter common justification form file
just_form <- just_form_hr %>% filter(PX_ID %in% cand_list$PX_ID)

# filter support device file
# support_device <- thor_support_device %>% filter(PX_ID %in% cand_list$PX_ID)

# filter data linking dataframe
data_link <- just_form_hr_data_link %>% filter(PX_ID %in% cand_list$PX_ID)

# filter Status 1A justification forms
just_stat1a <- stat_just_hr1a %>% filter(PX_ID %in% cand_list$PX_ID)

# filter Status 1B justification forms
just_stat1b <- stat_just_hr1b %>% filter(PX_ID %in% cand_list$PX_ID)

# filter Status 1 justification forms
just_stat1 <- just_form_hr_stat1 %>% filter(PX_ID %in% cand_list$PX_ID)

# filter Status 2 (new policy) justification forms
just_stat2 <- just_form_hr_stat2 %>% filter(PX_ID %in% cand_list$PX_ID)

# filter Status 3 justification forms
just_stat3 <- just_form_hr_stat3 %>% filter(PX_ID %in% cand_list$PX_ID)

# filter Status 4 justification forms
just_stat4 <- just_form_hr_stat4 %>% filter(PX_ID %in% cand_list$PX_ID)

rm(cand_thor, tx_hr, risk_strat_data_hr, stathist_thor, just_form_hr,
   stat_just_hr1a, stat_just_hr1b, just_form_hr_stat1, just_form_hr_stat2,
   just_form_hr_stat3, just_form_hr_stat4, thor_support_device,
   status_just_episode, just_form_hr_data_link)

```

# 4. Pivot cand_list and stathist by date, then full_join to create full_list

```{r pivot cand_list and stathist}

# this block selects the 45 variables from cand_thor currently used in analysis
cand_list <- cand_list %>% 
  select(
    PX_ID, WL_ORG, CAN_GENDER, CAN_ABO, CAN_RACE, CAN_LISTING_DT, CAN_REM_DT,
    CAN_REM_CD, CAN_DGN, CAN_ECMO, CAN_VENTILATOR, CAN_IABP, CAN_IV_INOTROP,
    CAN_VAD_TY, CAN_VAD1, CAN_PRIMARY_PAY, CAN_HGT_CM, CAN_WGT_KG, CAN_BMI,
    CAN_DIAB_TY, CAN_DIAL, CAN_CEREB_VASC, CAN_MOST_RECENT_CREAT,
    CAN_TOT_ALBUMIN, CAN_IMPLANT_DEFIB, CAN_PULM_ART_MEAN, CAN_PCW_MEAN,
    CAN_CARDIAC_OUTPUT, CAN_HIST_CIGARETTE, CAN_MALIG, CAN_LAST_STAT,
    CAN_AGE_IN_MONTHS_AT_LISTING, CAN_INIT_STAT, CAN_ANGINA, CAN_ANGINA_CAD, 
    CAN_PEPTIC_ULCER, CAN_EXERCISE_O2, CAN_DRUG_TREAT_HYPERTEN, CAN_PERIPH_VASC,
    CAN_ANTI_ARRYTHM, CAN_OTHER_TOBACCO_USE, CAN_PULM_EMBOL,
    PERS_SSA_DEATH_DT, PERS_OPTN_DEATH_DT)

cand_list_missing_data_check <- tibble(
  pct_missing = vector(mode = "double", length = ncol(cand_list)),
  var_names = colnames(cand_list))

for (i in 1:ncol(cand_list)) {
  
  cand_list_missing_data_check$pct_missing[i] <-
    sum(is.na(cand_list[, i])) / nrow(cand_list)
}

cand_list_missing_data_check <- cand_list_missing_data_check %>% 
  filter(pct_missing >= missingness_threshold) %>% 
  arrange(desc(pct_missing))

# this line removes variables which do not meet missingness criteria
cand_list <- cand_list %>% select(-cand_list_missing_data_check$var_names)

cand_list <- cand_list %>%
  distinct(.keep_all = TRUE) %>% 
  pivot_longer(cols = ends_with("DT"),
               names_to = "event", 
               values_to = "date", 
               values_drop_na = TRUE) %>%
  arrange(date) %>% 
  group_by(date) %>% 
  mutate(unique_date = date) %>%
  group_by(PX_ID, date) %>% 
  mutate(unique_event = event) %>% 
  pivot_wider(names_from = event, values_from = date) %>% 
  arrange(PX_ID, unique_date) %>% 
  ungroup() %>%
  select(PX_ID, unique_event, unique_date, 
         WL_ORG:CAN_PULM_EMBOL)

# perform same pivoting operation as above with stathist
stathist <- stathist %>% 
  select(PX_ID, CANHX_BEGIN_DT, CANHX_STAT_CD, 
         CANHX_REASON_STAT_INACT) %>% 
  pivot_longer(cols = ends_with("DT"),
               names_to = "event", 
               values_to = "date", 
               values_drop_na = TRUE) %>%
  arrange(date) %>% 
  group_by(date) %>% 
  mutate(unique_date = date) %>%
  group_by(PX_ID, date) %>% 
  mutate(unique_event = event) %>% 
  pivot_wider(names_from = event, values_from = date) %>%
  arrange(PX_ID, unique_date) %>% 
  ungroup() %>%
  select(PX_ID, unique_event, unique_date, CANHX_STAT_CD, 
         CANHX_REASON_STAT_INACT)

full_list <- cand_list %>% 
  
  # full join by common variables, thus no need for suffix
  full_join(stathist, by = c("PX_ID", "unique_date", "unique_event")) %>% 
  relocate(CANHX_STAT_CD:CANHX_REASON_STAT_INACT, .after = unique_date) %>% 
  
  # combines events if events happened on the same day
  # group_by(PX_ID, unique_date) %>%
  # mutate(unique_event = str_c(unique_event, collapse = ",")) %>%

  # removes redundant rows after combining events above
  # group_by(PX_ID, unique_date) %>%
  # fill(everything(), .direction = "downup") %>%
  # distinct(PX_ID, unique_date, unique_event, .keep_all = TRUE) %>%

  # arranges dataset for easy viewing
  arrange(PX_ID, unique_date) %>% 
  ungroup()
  
```

# 5. Pivot tx_list by date, then join with full_list

```{r pivot tx_list}

# repeat the same process as above with tx_list dataset
tx_list <- tx_list %>% 
  distinct(.keep_all = TRUE) %>% 
  select(PX_ID, ORG_TY, REC_TX_DT, REC_POSTX_LOS, REC_A_MM_EQUIV_TX,
         REC_B_MM_EQUIV_TX, REC_DR_MM_EQUIV_TX, REC_DGN, REC_CTR_CD,
         REC_CTR_TY, REC_DISCHRG_DT, REC_ADMISSION_DT, REC_MED_COND, 
         REC_FUNCTN_STAT, REC_PRIMARY_PAY, REC_HGT_CM, REC_WGT_KG,
         REC_BMI, REC_HIV_STAT, REC_CMV_STAT, REC_HCV_STAT,
         REC_EBV_STAT, REC_LIFE_SUPPORT, REC_ECMO,
         REC_IABP, REC_PGE, REC_INOTROP, REC_VENTILATOR, REC_VAD1,
         REC_VAD2, REC_CREAT, REC_TOT_BILI, REC_CHRONIC_STEROIDS,
         REC_TXFUS, REC_INFECT_IV_DRUG, REC_DIAL, 
         REC_VENTILATOR_SUPPORT, REC_HR_ISCH, REC_POSTX_STROKE,
         REC_POSTX_DIAL, REC_POSTX_PACEMAKER,
         REC_ACUTE_REJ_EPISODE, REC_CTR_ID, REC_AGE_IN_MONTHS_AT_TX,
         REC_A1, REC_A2, REC_B1, REC_B2, REC_DR1, REC_DR2,
         TFL_LASTATUS, TFL_GRAFT_DT, TFL_DEATH_DT,
         PERS_RETX, TFL_LAFUDATE, REC_MM_EQUIV_TX)

tx_list_missing_data_check <- tibble(
  pct_missing = vector(mode = "double", length = ncol(tx_list)),
  var_names = colnames(tx_list))

for (i in 1:ncol(tx_list)) {
  
  tx_list_missing_data_check$pct_missing[i] <-
    sum(is.na(tx_list[, i])) / nrow(tx_list)
}

tx_list_missing_data_check <- tx_list_missing_data_check %>% 
  filter(pct_missing >= missingness_threshold) %>% 
  arrange(desc(pct_missing))

# this line removes variables which do not meet missingness criteria
tx_list <- tx_list %>% select(-tx_list_missing_data_check$var_names)


tx_list <- tx_list %>% 
  mutate(TFL_LAST_FU_DT = TFL_LAFUDATE) %>%
  select(-TFL_LAFUDATE) %>% 
  pivot_longer(cols = ends_with("DT"),
               names_to = "event", 
               values_to = "date", 
               values_drop_na = TRUE) %>%
  arrange(date) %>% 
  group_by(date) %>% 
  mutate(unique_date = date) %>%
  group_by(PX_ID, date) %>% 
  mutate(unique_event = event) %>% 
  pivot_wider(names_from = event, values_from = date) %>% 
  arrange(PX_ID, unique_date) %>% 
  ungroup() %>% 
  select(PX_ID, unique_event, unique_date, ORG_TY:REC_MM_EQUIV_TX)

full_list <- full_list %>% 
  
  # full join by common variables, thus no need for suffix
  full_join(tx_list, by = c("PX_ID", "unique_date", "unique_event")) %>% 
  
  # combines events if events in cand_list and tx_list happened on the same day
  # group_by(PX_ID, unique_date) %>%
  # mutate(unique_event = str_c(unique_event, collapse = ",")) %>%

  # # removes redundant rows after combining events above
  # group_by(PX_ID, unique_date) %>%
  # fill(everything(), .direction = "downup") %>%
  # distinct(PX_ID, unique_date, unique_event, .keep_all = TRUE) %>%
  
  # arranges dataset for easy viewing
  arrange(PX_ID, unique_date) %>% 
  ungroup()

```

# 6. Join just_form and just_stat1-just_stat4 with risk_strat, 
#    pivot by date, then join with full_list

```{r pivot just_form and risk_strat}

just_stat1 <- just_stat1 %>% 
  distinct(across(-JustId), .keep_all = TRUE) %>% 
  mutate(across(ends_with("Dt"), ~ floor_date(.x, unit = "day")))

just_stat2 <- just_stat2 %>% 
  distinct(across(-JustId), .keep_all = TRUE) %>% 
  mutate(across(ends_with("Dt"), ~ floor_date(.x, unit = "day")))

just_stat3 <- just_stat3 %>% 
  distinct(across(-JustId), .keep_all = TRUE) %>% 
  mutate(across(ends_with("Dt"), ~ floor_date(.x, unit = "day")))

just_stat4 <- just_stat4 %>% 
  distinct(across(-JustId), .keep_all = TRUE) %>% 
  mutate(across(ends_with("Dt"), ~ floor_date(.x, unit = "day")))

risk_strat <- risk_strat %>%
  mutate(across(ends_with("Dt"), ~ floor_date(.x, unit = "day"))) %>%
  
  # adding just_form and just_stat1-4 columns to risk_strat
  full_join(just_form, by = c("ChangeDt", "JustId", "PX_ID")) %>%
  full_join(just_stat1, by = c("JustId", "PX_ID", "ChangeDt")) %>%
  full_join(just_stat2, by = c("JustId", "PX_ID", "ChangeDt"),
            suffix = c(".stat1", ".stat2")) %>%
  full_join(just_stat3, by = c("JustId", "PX_ID", "ChangeDt"),
            suffix = c(".stat2", ".stat3")) %>% 
  full_join(just_stat4, by = c("JustId", "PX_ID", "ChangeDt"),
            suffix = c(".stat3", ".stat4")) %>%
  
  pivot_longer(cols = contains("Dt", ignore.case = FALSE),
               names_to = "event", 
               values_to = "date", 
               values_drop_na = TRUE) %>% 
  
  group_by(date) %>% 
  mutate(unique_date = date) %>%
  group_by(PX_ID, date) %>% 
  mutate(unique_event = event) %>% 
  ungroup() %>% 
  pivot_wider(names_from = event, values_from = date) %>% 

  # risk_strat variables
  mutate(across(starts_with("CPTest"), ~ case_when(!is.na(CPTestDt) ~ .))) %>% 
  mutate(across(starts_with("Hemo"), ~ case_when(!is.na(HemoDt) ~ .))) %>%
  mutate(
    VadLdhLevels = case_when(!is.na(VadLdhLevelsDt) ~ VadLdhLevels),
    VadPlasmaFreeHemo = case_when(!is.na(VadPlasmaFreeHemoDt) ~ VadPlasmaFreeHemo),
    HrSevFailSodium = case_when(!is.na(HrSevFailSodiumDt) ~ HrSevFailSodium),
    HrSevFailCreatinine = case_when(!is.na(HrSevFailCreatinineDt) ~ HrSevFailCreatinine),
    HrSevFailBun = case_when(!is.na(HrSevFailBunDt) ~ HrSevFailBun),
    HrSevFailAlbumin = case_when(!is.na(HrSevFailAlbuminDt) ~ HrSevFailAlbumin),
    HrSevFailAsparTrans = case_when(!is.na(HrSevFailAsparTransDt) ~ HrSevFailAsparTrans),
    HrSevFailBilirubin = case_when(!is.na(HrSevFailBilirubinDt) ~ HrSevFailBilirubin),
    HrSevFailArterialLact = case_when(!is.na(HrSevFailArterialLactDt) ~
                                        HrSevFailArterialLact),
    HrSevFailInr = case_when(!is.na(HrSevFailInrDt) ~ HrSevFailInr),
    HrSevFailInrAntiCoag = case_when(!is.na(HrSevFailInrDt) ~ HrSevFailInrAntiCoag),
    HrSevFailBnp = case_when(!is.na(HrSevFailBnpDt) ~ HrSevFailBnp)) %>%
  
  # ChangeDt
  mutate(RequestedCandStatCd = case_when(!is.na(ChangeDt) ~
                                            RequestedCandStatCd)) %>% 
    
  # just_stat1 variables
  mutate(
    EcmoSystolicBloodPressure = case_when(!is.na(EcmoSystolicBloodPressureDt) ~
                                            EcmoSystolicBloodPressure),
    EcmoCardiacIndex = case_when(!is.na(EcmoCardiacIndexDt) ~
                                   EcmoCardiacIndex),
    EcmoCapWedgePressure = case_when(!is.na(EcmoCapWedgePressureDt) ~
                                   EcmoCapWedgePressure),
    EcmoWithoutHemoSbp = case_when(!is.na(EcmoWithoutHemoSbpDt) ~
                                   EcmoWithoutHemoSbp),
    EcmoWithoutHemoArtLac = case_when(!is.na(EcmoWithoutHemoArtLacDt) ~
                                   EcmoWithoutHemoArtLac),
    EcmoWithoutHemoAst = case_when(!is.na(EcmoWithoutHemoAstDt) ~
                                   EcmoWithoutHemoAst),
    EcmoWithoutHemoAlt = case_when(!is.na(EcmoWithoutHemoAltDt) ~
                                   EcmoWithoutHemoAlt),
    ExtMeanPressure.stat1 = case_when(!is.na(ExtMeanPressureDt.stat1) ~
                                   ExtMeanPressure.stat1),
    ExtCardiacIndex.stat1 = case_when(!is.na(ExtCardiacIndexDt.stat1) ~
                                   ExtCardiacIndex.stat1),
    ExtCapWedgePressure.stat1 = case_when(!is.na(ExtCapWedgePressureDt.stat1) ~
                                   ExtCapWedgePressure.stat1),
    ExtSvo2.stat1 = case_when(!is.na(ExtSvo2Dt.stat1) ~
                                   ExtSvo2.stat1)) %>% 
  
  # just_stat2 variables
  mutate(
    McsdCardiacIndex = case_when(!is.na(McsdCardiacIndexDt) ~ McsdCardiacIndex),
    McsdCapWedgePressure = case_when(!is.na(McsdCapWedgePressureDt) ~
                                       McsdCapWedgePressure),
    McsdSystolicBloodPressure = case_when(!is.na(McsdSystolicBloodPressureDt) ~
                                       McsdSystolicBloodPressure),
    McsdWithoutHemoSbp = case_when(!is.na(McsdWithoutHemoSbpDt) ~
                                       McsdWithoutHemoSbp),
    McsdWithoutHemoArtLac = case_when(!is.na(McsdWithoutHemoArtLacDt) ~
                                       McsdWithoutHemoArtLac),
    McsdWithoutHemoAst = case_when(!is.na(McsdWithoutHemoAstDt) ~
                                       McsdWithoutHemoAst),
    
    # this date variable disappears after the full_join above because 
    # it is completely missing values
    # apparently, very few to no patients get their ALT recorded
    # McsdWithoutHemoAlt = case_when(!is.na(McsdWithoutHemoAltDt) ~
    #                                    McsdWithoutHemoAlt),
    
    IabpCardiacIndex = case_when(!is.na(IabpCardiacIndexDt) ~
                                       IabpCardiacIndex),
    IabpCapWedgePressure = case_when(!is.na(IabpCapWedgePressureDt) ~
                                       IabpCapWedgePressure),
    IabpSystolicBloodPressure = case_when(!is.na(IabpSystolicBloodPressureDt) ~
                                       IabpSystolicBloodPressure),
    IabpWithoutHemoSbp = case_when(!is.na(IabpWithoutHemoSbpDt) ~
                                       IabpWithoutHemoSbp),
    IabpWithoutHemoArtLac = case_when(!is.na(IabpWithoutHemoArtLacDt) ~
                                       IabpWithoutHemoArtLac),
    IabpWithoutHemoAst = case_when(!is.na(IabpWithoutHemoAstDt) ~
                                       IabpWithoutHemoAst),
    IabpWithoutHemoAlt = case_when(!is.na(IabpWithoutHemoAltDt) ~
                                       IabpWithoutHemoAlt),
    ExtMeanPressure.stat2 = case_when(!is.na(ExtMeanPressureDt.stat2) ~
                                   ExtMeanPressure.stat2),
    ExtCardiacIndex.stat2 = case_when(!is.na(ExtCardiacIndexDt.stat2) ~
                                   ExtCardiacIndex.stat2),
    ExtCapWedgePressure.stat2 = case_when(!is.na(ExtCapWedgePressureDt.stat2) ~
                                   ExtCapWedgePressure.stat2),
    ExtSvo2.stat2 = case_when(!is.na(ExtSvo2Dt.stat2) ~
                                   ExtSvo2.stat2)) %>%
  
  # just_stat3 variables
  mutate(
    InoCardiacIndex = case_when(!is.na(InoCardiacIndexDt) ~ InoCardiacIndex),
    InoCapWedgePressure = case_when(!is.na(InoCapWedgePressureDt) ~
                                      InoCapWedgePressure),
    InoSysBloodPressure = case_when(!is.na(InoSysBloodPressureDt) ~
                                      InoSysBloodPressure),
    McsdWithRhfDobutamine = case_when(!is.na(McsdWithRhfDobutamineDt) ~
                                      McsdWithRhfDobutamine),
    
    # this date variable also disappears after the full_join above because
    # it is all NAs
    # McsdWithRhfDopamine = case_when(!is.na(McsdWithRhfDopamineDt) ~
    #                                   McsdWithRhfDopamine),
    
    McsdWithRhfEpinephrine = case_when(!is.na(McsdWithRhfEpinephrineDt) ~
                                      McsdWithRhfEpinephrine),
    McsdWithRhfMilrinone = case_when(!is.na(McsdWithRhfMilrinoneDt) ~
                                      McsdWithRhfMilrinone),
    
    # these date variables also disappear after the full_join above because
    # they are all NAs
    # McsdWithRhfNitricOxide = case_when(!is.na(McsdWithRhfNitricOxideDt) ~
    #                                   McsdWithRhfNitricOxide),
    # McsdWithRhfProstacyclin = case_when(!is.na(McsdWithRhfProstacyclinDt) ~
    #                                   McsdWithRhfProstacyclin),
    
    McsdWithRhfPcwp = case_when(!is.na(McsdWithRhfPcwpDt) ~
                                      McsdWithRhfPcwp),
    McsdWithRhfVenPressure = case_when(!is.na(McsdWithRhfVenPressureDt) ~
                                      McsdWithRhfVenPressure)) %>%
  
  # just_stat4 variables
   mutate(
    InotropeCardiacIndex = case_when(!is.na(InotropeCardiacIndexDt) ~
                                       InotropeCardiacIndex),
    InotropePcwp = case_when(!is.na(InotropePcwpDt) ~
                                       InotropePcwp)) %>%
  
   mutate(
    systolicBP = coalesce(HemoSbp, EcmoWithoutHemoSbp, McsdWithoutHemoSbp,
                          IabpWithoutHemoSbp, EcmoSystolicBloodPressure,
                          McsdSystolicBloodPressure, IabpSystolicBloodPressure,
                          InoSysBloodPressure),
    PCWP = coalesce(HemoPcwp, McsdWithRhfPcwp, InotropePcwp, 
                    EcmoCapWedgePressure, McsdCapWedgePressure, 
                    IabpCapWedgePressure, InoCapWedgePressure, 
                    ExtCapWedgePressure.stat1, ExtCapWedgePressure.stat2),
    mean_arterial_pressure = coalesce(ExtMeanPressure.stat1, ExtMeanPressure.stat2),
    central_venous_pressure = coalesce(HemoCvp, McsdWithRhfVenPressure),
    SVO2 = coalesce(HemoSvo2, ExtSvo2.stat1, ExtSvo2.stat2),
    cardiac_index = coalesce(HemoCardiacIndex, EcmoCardiacIndex, McsdCardiacIndex,
                             IabpCardiacIndex, InoCardiacIndex, 
                             InotropeCardiacIndex, ExtCardiacIndex.stat1,
                             ExtCardiacIndex.stat2),
    arterial_lactate = coalesce(EcmoWithoutHemoArtLac, McsdWithoutHemoArtLac,
                                IabpWithoutHemoArtLac, HrSevFailArterialLact),
    AST = coalesce(EcmoWithoutHemoAst, McsdWithoutHemoAst, IabpWithoutHemoAst,
                   HrSevFailAsparTrans),
    ALT = coalesce(EcmoWithoutHemoAlt, McsdWithoutHemoAlt, IabpWithoutHemoAlt),
    dobutamine_dose = coalesce(McsdWithRhfDobutamine, InotropeDobutamine),
    milrinone_dose = coalesce(McsdWithRhfMilrinone, InotropeMilrinone),
    dopamine_dose = coalesce(McsdWithRhfDopamine, InotropeDopamine),
    epinephrine_dose = coalesce(McsdWithRhfEpinephrine, InotropeEpinephrine)) %>% 

  arrange(PX_ID, unique_date)

# indicator variables from just_stat1-just_stat4
just_form_indicator_variables <- c(
  
         # just_stat1 variables
         "CriteriaEcmoSupport", "EcmoWithHemo",
         "CardiacIndexInotropeSupport", "EcmoWithoutHemo", "ExtDemoContra.stat1",
         "CriteriaBivadSupport", "CriteriaMcsdSupport", "VentricularEpisode",
         "BivadPlacement",

         # just_stat2 variables
         "CriteriaLvadSupport.stat2", "CriteriaDurableDevSupport",
         "CriteriaMcsdMalfunction", "CriteriaMcsdEndovasSupp", "McsdWithHemo",
         "McsdCardiacIndexInotropeSup", "McsdWithoutHemo",
         "CriteriaIabpSupport.stat2", "IabpWithHemo",
         "IabpCardiacIndexInotropeSup", "IabpWithoutHemo", "CriteriaVentEpisode",
         "ExtDemoContra.stat2",

         # just_stat3 variables
         "CriteriaLvadDiscSupport", "CriteriaInotropeSupport.stat3",
         "InoInvasiveCatheter", "InoHemodynamicMonitoring", "InoSingle", "InoMultiple",
         "InoSinDobutamine", "InoSinMilrinone", "InoSinEpinephrine", "InoMulDobutamine",
         "InoMulMilrinone", "InoMulEpinephrine", "InoMulDopamine", "InoInotropeSupport",
         "CriteriaMcsdWithHemo", "McsdLactateDehydrogenase", 
         "McsdPlasmaFreeHemoglobin", "McsdHemoglobinuria", "CriteriaMcsdWithPump",
         "McsdWithPumpThrombosis", "McsdWithPumpTransIscAttack", 
         "CriteriaMcsdWithRhf",
         # McsdWithRhfNitricOxide, McsdWithRhfProstacyclin,
         "CriteriaMcsdInfection", "McsdInfectionErythema", "McsdInfectionDebridement",
         "McsdInfectionBacAnti", "McsdInfectionBacReccur", "McsdInfectionPosCulture",
         "CriteriaMcsdMucosalBleed", "MucosalBleedNumHosp", "CriteriaMcsdWithAI",
         "CriteriaVaEcmoSupport", "CriteriaLvadSupport.stat3", "CriteriaPercuSupport",
         "CriteriaIabpSupport.stat3", "ExtInoSingleDose", "ExtInoMultiDose",
         "ExtInoSinDobutamine", "ExtInoSinMilrinone", "ExtInoSinEpinephrine",
         "ExtInoMulDobutamine", "ExtInoMulMilrinone", "ExtInoMulEpinephrine",
         "ExtInoMulDopamine", "ExtInvasiveCatheter", "ExtHemodynamicMonitoring",
         "ExtCardiacIndx", "ExtFailedWeaningAttempt", "ExtFWACardiacIndex",
         "ExtFWASerumCreatinine", "ExtFWAArterialLactate", "ExtFWASvo2",
         "ExtMcsdDobutamine", "ExtMcsdDopamine", "ExtMcsdEpinephrine",
         "ExtMcsdMilrinone", "ExtMcsdNitricOxide", "ExtMcsdProstacyclin",

         # just_stat4 variables
         "CriteriaLvadSupport", "CriteriaInotropeSupport.stat4",
         "CriteriaHeartDisease", "HeartDiseaseValues", "HeartDiseaseOther",
         "CriteriaIschemicHeart", "CriteriaCardiomyopathy", "CardioHypertrophic",
         "CardioAmyloidosis", "CardioRestrict", "CardiomyopathyCanadian",
         "CardiomyopathyNyha", "CardiomyopathyNyhaCdx", "CardiomyopathyNyhaPcwp",
         "CardiomyopathyVenTachy", "CardiomyopathyVenFib", "CardiomyopathyVenArr",
         "CardiomyopathySuddenDeath", "CriteriaRetransplant", "ExtInotropeDobutamine",
         "ExtInotropeMilrinone", "ExtInotropeEpinephrine", "ExtInotropeDopamine")
  
risk_strat <- risk_strat %>%   
  select(PX_ID, JustId, unique_date, unique_event,
         
         # aggregated variables
         systolicBP, PCWP, mean_arterial_pressure, central_venous_pressure, 
         SVO2, cardiac_index, arterial_lactate, AST, ALT, dobutamine_dose,
         milrinone_dose, dopamine_dose, epinephrine_dose,
         
         # risk_strat variables
         CPTestMvo2, CPTestRer, CPTestVeVco2, HemoObtainedOnSupport, HemoDbp,
         HemoRestingHeartRate, HemoPasp, HemoPadp, HemoMeanPressure, HemoLvedp,
         HemoCardiacOutput, HemoHemoglobin, VadLdhLevels, VadPlasmaFreeHemo,
         VadHemoglobinuria, HrSevFailSodium, HrSevFailCreatinine,
         HrSevFailBun, HrSevFailAlbumin, HrSevFailBilirubin, HrSevFailInr,
         HrSevFailInrAntiCoag, HrSevFailBnp, RequestedCandStatCd,
         ExtensionNumber, Exception, AdmittedToHospital, listing_description,
         
         # indicator variables from just_stat1-just_stat4
         all_of(just_form_indicator_variables))

         
risk_strat <- risk_strat %>%
  
  pivot_longer(cols = -c(PX_ID, JustId, unique_date, unique_event,
                         dobutamine_dose, milrinone_dose, dopamine_dose,
                         epinephrine_dose, HemoObtainedOnSupport, 
                         VadHemoglobinuria, HrSevFailInrAntiCoag,
                         ExtensionNumber, Exception, AdmittedToHospital,
                         listing_description, 
                         all_of(just_form_indicator_variables)),
               names_to = "variable", 
               values_to = "value", 
               values_drop_na = TRUE) %>% 
  relocate(variable, value, .after = unique_event) %>% 

  distinct(across(c(PX_ID, unique_date, variable, value)), .keep_all = TRUE) %>% 
  arrange(PX_ID, JustId, unique_date)

duplicated_JustId <- risk_strat %>% 
  group_by(PX_ID, unique_date, variable) %>% 
  filter(n() > 1) %>% 
  group_by(PX_ID, unique_date, variable) %>% 
  select(JustId) %>% 
  ungroup()

earlier_JustId <- risk_strat %>% 
  group_by(PX_ID, unique_date, variable) %>% 
  filter(n() > 1) %>% 
  group_by(PX_ID, unique_date, variable) %>% 
  slice_min(JustId) %>% 
  select(JustId) %>% 
  ungroup()

later_JustId <- duplicated_JustId %>% anti_join(earlier_JustId)
  
later_ChangeDt <- risk_strat %>% 
  select(PX_ID, unique_date, variable, JustId) %>% 
  filter(grepl("RequestedCandStatCd", variable)) %>% 
  semi_join(later_JustId, by = c("PX_ID", "JustId"))

merged_JustId <- later_JustId %>% 
  left_join(later_ChangeDt %>% select(-variable), 
            by = c("PX_ID", "JustId"), 
            suffix = c("", ".replaced"))

risk_strat <- risk_strat %>% 
  left_join(merged_JustId, 
            by = c("PX_ID", "JustId", "variable", "unique_date")) %>% 
  mutate(unique_date = case_when(
    !is.na(unique_date.replaced) ~ unique_date.replaced,
    is.na(unique_date.replaced) ~ unique_date)) %>% 
  
  mutate(date_changed = case_when(
    !is.na(unique_date.replaced) ~ variable)) %>%
  
  select(-unique_date.replaced) %>% 
  distinct(across(c(PX_ID, unique_date, variable)), .keep_all = TRUE)

# rm(duplicated_JustId, earlier_JustId, later_JustId, later_ChangeDt, merged_JustId)

risk_strat <- risk_strat %>% 
  pivot_wider(names_from = variable,
              values_from = value) %>% 
 
  relocate(systolicBP, PCWP, mean_arterial_pressure, central_venous_pressure, 
         SVO2, cardiac_index, arterial_lactate, AST, ALT,
         HemoDbp, HemoRestingHeartRate, HemoPasp, HemoPadp, HemoMeanPressure,
         HemoLvedp, HemoCardiacOutput, HemoHemoglobin, CPTestMvo2, CPTestRer,
         CPTestVeVco2, VadLdhLevels, VadPlasmaFreeHemo, HrSevFailSodium,
         HrSevFailCreatinine, HrSevFailBun, HrSevFailAlbumin, 
         HrSevFailBilirubin, HrSevFailInr, HrSevFailBnp, RequestedCandStatCd,
         .after = unique_event) %>% 
  mutate(RequestedCandStatCd = as.integer(RequestedCandStatCd))

risk_strat <- risk_strat %>%
  
  pivot_longer(cols = starts_with("Criteria", ignore.case = FALSE),
               names_to = "criteria", 
               values_to = "indicator", 
               values_drop_na = FALSE) %>% 
  relocate(criteria, indicator, .after = unique_event) %>% 
  mutate(status_criteria = ifelse(indicator == 1, criteria, NA)) %>%
  filter(is.na(indicator) | indicator == 1) %>% 
  
  pivot_wider(names_from = criteria,
              values_from = indicator) %>% 
  
  relocate(status_criteria, .after = unique_event) %>% 
  arrange(PX_ID, JustId, unique_date) %>% 
  group_by(PX_ID, JustId, unique_event, unique_date) %>% 
  filter(row_number() == n()) %>% 
  ungroup() %>% 
  select(-starts_with("Criteria")) %>% 
  distinct(PX_ID, unique_event, unique_date, .keep_all = TRUE)

full_list <- full_list %>%

  # full join by common variables, thus no need for suffix
  full_join(risk_strat, by = c("PX_ID", "unique_date", "unique_event")) %>%

  # combines events if events happened on the same day
  # group_by(PX_ID, unique_date) %>%
  # mutate(unique_event = str_c(unique_event, collapse = ",")) %>%

  # removes redundant rows after combining events above
  # group_by(PX_ID, unique_date) %>%
  # fill(everything(), .direction = "downup") %>%
  # distinct(PX_ID, unique_date, unique_event, .keep_all = TRUE) %>%

  relocate(JustId, .after = PX_ID) %>%

  # arranges dataset for easy viewing
  arrange(PX_ID, unique_date) %>%
  ungroup()

```

# 7. Pivot old policy justification forms by date, then join with full_list

```{r pivot old just forms}

just_stat1a_1b <- just_stat1a %>%
  full_join(just_stat1b,
            by = c("WL_ORG", "PX_ID", "CANHX_STAT_CD", "CANHX_STAT_TY",
                   "CANHX_INIT_FORM", "CANHX_CHG_DT", "CANHX_FORM_STAT", 
                   "CANHX_AGE_GROUP", "CANHX_DGN", "CANHX_VAD", 
                   "CANHX_VAD_IMPLANT_DT", "CAN_LISTING_CTR_ID"))

# rm(just_stat1a, just_stat1b)

just_stat1a_1b <- just_stat1a_1b %>%

  # include only completed forms (small minority are excluded by this step)
  filter(CANHX_FORM_STAT == 4 | CANHX_FORM_STAT == 8) %>%

  # remove duplicate forms
  distinct(PX_ID, CANHX_CHG_DT, .keep_all = TRUE) %>%
  
  mutate(low_dose_inotrope =
           pmax(CANHX_REQUIRE_LOW_INOTROP, CANHX_CONT_IV_INOTROP)) %>%
  
  arrange(CANHX_CHG_DT) %>% 
  
  # RowNumber is the equivalent of JustId
  # there is no JustId variable for pre-policy justification forms,
  # so RowNumber serves that purpose
  mutate(RowNumber = row_number()) %>% 
  
  select(RowNumber, PX_ID, CANHX_STAT_CD, 
         CANHX_STAT_TY, CANHX_FORM_STAT, CANHX_DGN, CANHX_ADMITTED,
         CANHX_ADULT_CRITERIA_A, CANHX_ADULT_CRITERIA_B, CANHX_ADULT_CRITERIA_C,
         CANHX_ADULT_CRITERIA_D, CANHX_ADULT_CRITERIA_E, CANHX_VAD,
         CANHX_LVAD_TYPE, CANHX_RVAD_TYPE, CANHX_TAH, CANHX_IABP, CANHX_ECMO,
         CANHX_THROMB_EMBOL, CANHX_DEV_INFECT, CANHX_DEV_MALFUNCTN,
         CANHX_DEV_VENT_ARRYTHM, CANHX_DEV_OTHER, CANHX_INTRP_DOBU,
         CANHX_INTRP_DOPA, CANHX_INTRP_MILRIN, CANHX_HEMO_INTRP_OBTAINED,
         CANHX_HEMO_REST_HR_RATE, CANHX_HEMO_MAP, CANHX_HEMO_SBP,
         CANHX_HEMO_DBP, CANHX_HEMO_CVP, CANHX_HEMO_PASP, CANHX_HEMO_PADP,
         CANHX_HEMO_MPAP, CANHX_HEMO_PCWP, CANHX_CARD_OUTPUT, CANHX_HEMO_CI,
         CANHX_DIALYSIS, CANHX_LAB_SERUM_CREAT, CANHX_LAB_BILI,
         CANHX_LAB_ALBUMIN, CANHX_LAB_SODIUM, CANHX_LAB_SGOT, CANHX_LAB_BNP,
         CAN_LISTING_CTR_ID, CANHX_CHG_DT, CANHX_VAD_IMPLANT_DT, CANHX_LVAD_DT,
         CANHX_RVAD_DT, CANHX_TAH_DT, CANHX_IABP_DT, CANHX_ECMO_DT,
         CANHX_HEMO_DT, CANHX_LAB_DT,
         
         # just_stat1b variables
         CANHX_CRIT_NOT_MET, low_dose_inotrope) %>%
  
  pivot_longer(cols = ends_with("DT"),
               names_to = "event",
               values_to = "date",
               values_drop_na = TRUE) %>%
  
  group_by(date) %>% 
  mutate(unique_date = date) %>%
  group_by(PX_ID, date) %>% 
  mutate(unique_event = event) %>%
  ungroup() %>% 
  pivot_wider(names_from = event, values_from = date) %>%

  relocate(RowNumber, PX_ID, unique_event, unique_date) %>%

  mutate(
    CANHX_STAT_CD = case_when(!is.na(CANHX_CHG_DT) ~ CANHX_STAT_CD),
    CANHX_VAD = case_when(!is.na(CANHX_VAD_IMPLANT_DT) ~ CANHX_VAD),
    CANHX_LVAD_TYPE = case_when(!is.na(CANHX_LVAD_DT) ~ CANHX_LVAD_TYPE),
    CANHX_RVAD_TYPE = case_when(!is.na(CANHX_RVAD_DT) ~ CANHX_RVAD_TYPE),
    CANHX_TAH = case_when(!is.na(CANHX_TAH_DT) ~ CANHX_TAH),
    CANHX_IABP = case_when(!is.na(CANHX_IABP_DT) ~ CANHX_IABP),
    CANHX_ECMO = case_when(!is.na(CANHX_ECMO_DT) ~ CANHX_ECMO)) %>%

  mutate(across(starts_with("CANHX_HEMO"),
                ~ case_when(!is.na(CANHX_HEMO_DT) ~ .))) %>%

  mutate(across(starts_with("CANHX_LAB"),
                ~ case_when(!is.na(CANHX_LAB_DT) ~ .))) %>%

  select(RowNumber, PX_ID, unique_event, unique_date, CANHX_STAT_CD, 
         CANHX_STAT_TY, CANHX_FORM_STAT, CANHX_DGN, CANHX_ADMITTED,
         CANHX_ADULT_CRITERIA_A, CANHX_ADULT_CRITERIA_B, CANHX_ADULT_CRITERIA_C,
         CANHX_ADULT_CRITERIA_D, CANHX_ADULT_CRITERIA_E, CANHX_VAD,
         CANHX_LVAD_TYPE, CANHX_RVAD_TYPE, CANHX_TAH, CANHX_IABP, CANHX_ECMO,
         CANHX_THROMB_EMBOL, CANHX_DEV_INFECT, CANHX_DEV_MALFUNCTN,
         CANHX_DEV_VENT_ARRYTHM, CANHX_DEV_OTHER, CANHX_INTRP_DOBU,
         CANHX_INTRP_DOPA, CANHX_INTRP_MILRIN, CANHX_HEMO_INTRP_OBTAINED,
         CANHX_HEMO_REST_HR_RATE, CANHX_HEMO_MAP, CANHX_HEMO_SBP,
         CANHX_HEMO_DBP, CANHX_HEMO_CVP, CANHX_HEMO_PASP, CANHX_HEMO_PADP,
         CANHX_HEMO_MPAP, CANHX_HEMO_PCWP, CANHX_CARD_OUTPUT, CANHX_HEMO_CI,
         CANHX_DIALYSIS, CANHX_LAB_SERUM_CREAT, CANHX_LAB_BILI,
         CANHX_LAB_ALBUMIN, CANHX_LAB_SODIUM, CANHX_LAB_SGOT, CANHX_LAB_BNP,
         CAN_LISTING_CTR_ID,
         
         # just_stat1b variables
         CANHX_CRIT_NOT_MET, low_dose_inotrope) %>%

  arrange(PX_ID, unique_date)

just_stat1a_1b <- just_stat1a_1b %>%
  
  pivot_longer(cols = -c(PX_ID, RowNumber, unique_date, unique_event,
                         CANHX_STAT_TY, CANHX_FORM_STAT,
                         CANHX_DGN, CANHX_ADMITTED, 
                         CANHX_ADULT_CRITERIA_A, CANHX_ADULT_CRITERIA_B,
                         CANHX_ADULT_CRITERIA_C, CANHX_ADULT_CRITERIA_D,
                         CANHX_ADULT_CRITERIA_E, CANHX_THROMB_EMBOL,
                         CANHX_DEV_INFECT, CANHX_DEV_MALFUNCTN,
                         CANHX_DEV_VENT_ARRYTHM, CANHX_DEV_OTHER,
                         CANHX_INTRP_DOBU, CANHX_INTRP_DOPA,
                         CANHX_INTRP_MILRIN, CANHX_HEMO_INTRP_OBTAINED,
                         CANHX_DIALYSIS, CAN_LISTING_CTR_ID,
                         CANHX_CRIT_NOT_MET, low_dose_inotrope),
               names_to = "variable", 
               values_to = "value", 
               values_drop_na = TRUE) %>% 
  relocate(variable, value, .after = unique_event) %>% 

  distinct(across(c(PX_ID, unique_date, variable, value)), .keep_all = TRUE) %>%
  arrange(PX_ID, RowNumber, unique_date)

duplicated_RowNumber <- just_stat1a_1b %>% 
  group_by(PX_ID, unique_date, variable) %>% 
  filter(n() > 1) %>% 
  group_by(PX_ID, unique_date, variable) %>% 
  select(RowNumber) %>% 
  ungroup()

earlier_RowNumber <- just_stat1a_1b %>% 
  group_by(PX_ID, unique_date, variable) %>% 
  filter(n() > 1) %>% 
  group_by(PX_ID, unique_date, variable) %>% 
  slice_min(RowNumber) %>% 
  select(RowNumber) %>% 
  ungroup()

later_RowNumber <- duplicated_RowNumber %>% anti_join(earlier_RowNumber)
  
later_CHG_DT <- just_stat1a_1b %>% 
  select(PX_ID, unique_date, variable, RowNumber) %>% 
  filter(grepl("CANHX_STAT_CD", variable)) %>% 
  semi_join(later_RowNumber, by = c("PX_ID", "RowNumber"))

merged_RowNumber <- later_RowNumber %>% 
  left_join(later_CHG_DT %>% select(-variable), 
            by = c("PX_ID", "RowNumber"), 
            suffix = c("", ".replaced"))

just_stat1a_1b <- just_stat1a_1b %>% 
  left_join(merged_RowNumber, 
            by = c("PX_ID", "RowNumber", "variable", "unique_date")) %>% 
  mutate(unique_date = case_when(
    !is.na(unique_date.replaced) ~ unique_date.replaced,
    is.na(unique_date.replaced) ~ unique_date)) %>% 
  
  mutate(date_changed = case_when(
    !is.na(unique_date.replaced) ~ variable)) %>% 
  
  select(-unique_date.replaced) %>% 
  distinct(across(c(PX_ID, unique_date, variable)), .keep_all = TRUE)

# rm(duplicated_RowNumber, earlier_RowNumber, later_RowNumber, later_CHG_DT, 
#    merged_RowNumber)

just_stat1a_1b <- just_stat1a_1b %>% 
  pivot_wider(names_from = variable,
              values_from = value) %>% 
 
  mutate(CANHX_STAT_CD = as.integer(CANHX_STAT_CD)) %>% 
  arrange(PX_ID, unique_date)

full_list <- full_list %>%

  # full join by common variables, thus no need for suffix
  full_join(just_stat1a_1b, by = c("PX_ID", "unique_date", "unique_event", 
                                   "CANHX_STAT_CD", "date_changed")) %>%
  
  relocate(RowNumber, .after = JustId) %>% 

  # combines events if events happened on the same day
  group_by(PX_ID, unique_date) %>%
  mutate(unique_event = str_c(unique_event, collapse = ",")) %>%

  # removes redundant rows after combining events above
  group_by(PX_ID, unique_date) %>%
  fill(everything(), .direction = "downup") %>%
  distinct(PX_ID, unique_date, unique_event, .keep_all = TRUE) %>%

  mutate(
    systolicBP = coalesce(systolicBP, CANHX_HEMO_SBP),
    PCWP = coalesce(PCWP, CANHX_HEMO_PCWP),
    mean_arterial_pressure = coalesce(mean_arterial_pressure, CANHX_HEMO_MAP),
    central_venous_pressure = coalesce(central_venous_pressure, CANHX_HEMO_CVP),
    cardiac_index = coalesce(cardiac_index, CANHX_HEMO_CI),
    AST = coalesce(AST, CANHX_LAB_SGOT),
    dobutamine_dose = coalesce(dobutamine_dose, CANHX_INTRP_DOBU),
    milrinone_dose = coalesce(milrinone_dose, CANHX_INTRP_MILRIN),
    dopamine_dose = coalesce(dopamine_dose, CANHX_INTRP_DOPA),
    creatinine = coalesce(CANHX_LAB_SERUM_CREAT, HrSevFailCreatinine),
    bilirubin = coalesce(CANHX_LAB_BILI, HrSevFailBilirubin),
    albumin = coalesce(CANHX_LAB_ALBUMIN, HrSevFailAlbumin),
    sodium = coalesce(CANHX_LAB_SODIUM, HrSevFailSodium),
    BNP = coalesce(CANHX_LAB_BNP, HrSevFailBnp),
    cardiac_output = coalesce(CANHX_CARD_OUTPUT, HemoCardiacOutput),
    resting_HR = coalesce(CANHX_HEMO_REST_HR_RATE, HemoRestingHeartRate),
    diastolicBP = coalesce(CANHX_HEMO_DBP, HemoDbp),
    PASP = coalesce(CANHX_HEMO_PASP, HemoPasp),
    PADP = coalesce(CANHX_HEMO_PADP, HemoPadp),
    MPAP = coalesce(CANHX_HEMO_MPAP, HemoMeanPressure)) %>%

  select(-CANHX_HEMO_SBP, -CANHX_HEMO_PCWP, -CANHX_HEMO_MAP, -CANHX_HEMO_CVP,
         -CANHX_HEMO_CI, -CANHX_LAB_SGOT, -CANHX_INTRP_DOBU,
         -CANHX_INTRP_MILRIN, -CANHX_INTRP_DOPA, -CANHX_LAB_SERUM_CREAT,
         -HrSevFailCreatinine, -CANHX_LAB_BILI, -HrSevFailBilirubin,
         -CANHX_LAB_ALBUMIN, -HrSevFailAlbumin, -CANHX_LAB_SODIUM,
         -HrSevFailSodium, -CANHX_LAB_BNP, -HrSevFailBnp, -CANHX_CARD_OUTPUT,
         -HemoCardiacOutput, -CANHX_HEMO_REST_HR_RATE, -HemoRestingHeartRate,
         -CANHX_HEMO_DBP, -HemoDbp, -CANHX_HEMO_PASP, -HemoPasp,
         -CANHX_HEMO_PADP, -HemoPadp, -CANHX_HEMO_MPAP, -HemoMeanPressure) %>%
  
  relocate(systolicBP, PCWP, mean_arterial_pressure, central_venous_pressure, 
         SVO2, cardiac_output, cardiac_index, arterial_lactate, AST, ALT,
         creatinine, bilirubin, albumin, sodium, BNP, resting_HR, diastolicBP, 
         PASP, PADP, MPAP, HemoLvedp, HemoHemoglobin, CPTestMvo2, CPTestRer,
         CPTestVeVco2, VadLdhLevels, VadPlasmaFreeHemo, HrSevFailBun,
         HrSevFailInr,
         .after = unique_date) %>% 
  
  relocate(dobutamine_dose, milrinone_dose, dopamine_dose, epinephrine_dose,
           date_changed,
           .after = last_col()) %>% 

  # necessary for filling steps below
  arrange(PX_ID, unique_date) %>%

  # fill variables "down" to show change over time
  # this fills in missing values using the na.locf() method
  group_by(PX_ID) %>%
  fill(systolicBP:CANHX_STAT_CD, .direction = "down") %>%
  ungroup() %>%

  arrange(PX_ID, unique_date) %>%

  # fill cand_thor and tx_hr variables "downup" because these variables are static
  group_by(PX_ID) %>%
  fill(WL_ORG:REC_MM_EQUIV_TX, .direction = "downup") %>%
  ungroup() %>%

  arrange(PX_ID, unique_date) %>%

  # fill variables "down" to show change over time
  # this fills in missing values using the na.locf() method
  group_by(PX_ID, JustId) %>%
  fill(status_criteria:ExtInotropeDopamine, .direction = "down") %>%
  ungroup() %>%

  arrange(PX_ID, unique_date) %>%

  # fill variables "down" to show change over time
  # this fills in missing values using the na.locf() method
  group_by(PX_ID, RowNumber) %>%
  fill(CANHX_STAT_TY:CANHX_ECMO, .direction = "down") %>%
  ungroup() %>%

  arrange(PX_ID, unique_date) %>%

  # fill variables "downup" by JustId group to fill all rows from that form
  group_by(PX_ID, JustId, RowNumber) %>%
  fill(dobutamine_dose:epinephrine_dose, .direction = "downup") %>%
  ungroup() %>%

  # arranges dataset for easy viewing
  arrange(PX_ID, unique_date) %>%
  ungroup()
```

# 8. Method to filter full_list to exclude unwanted timepoints

```{r filter full_list}

# comment out lines below to exclude those timepoints from the dataset
# currently, dates are commented out except for listing, transplant, death, 
# last follow-up, and status changes

final_list <- full_list %>% 
  
  filter(
    
    # cand_thor variables
    grepl("CAN_LISTING_DT", unique_event) |
      grepl("PERS_OPTN_DEATH_DT", unique_event) |
      grepl("PERS_SSA_DEATH_DT", unique_event) |
      grepl("CAN_REM_DT", unique_event) |
      
      # stathist_thor variables
      grepl("CANHX_BEGIN_DT", unique_event) |
           
      # tx_hr variables
      grepl("REC_TX_DT", unique_event) |
      # grepl("REC_ADMISSION_DT", unique_event) |
      # grepl("REC_DISCHRG_DT", unique_event) |
      # grepl("TFL_GRAFT_DT", unique_event) |
      grepl("TFL_DEATH_DT", unique_event) |
      grepl("TFL_LAST_FU_DT", unique_event))
      
      # # just_form_hr variables
      # grepl("ChangeDt", unique_event) |
      # 
      # # just_form_hr_stat1 variables
      # grepl("EcmoSystolicBloodPressureDt", unique_event) |
      # grepl("EcmoCardiacIndexDt", unique_event) |
      # grepl("EcmoCapWedgePressureDt", unique_event) |
      # grepl("EcmoWithoutHemoCprDt", unique_event) |
      # grepl("EcmoWithoutHemoSbpDt", unique_event) |
      # grepl("EcmoWithoutHemoArtLacDt", unique_event) |
      # grepl("EcmoWithoutHemoAstDt", unique_event) |
      # grepl("EcmoWithoutHemoAltDt", unique_event) |
      # grepl("ExtMeanPressureDt.stat1", unique_event) |
      # grepl("ExtCardiacIndexDt.stat1", unique_event) |
      # grepl("ExtCapWedgePressureDt.stat1", unique_event) |
      # grepl("ExtSvo2Dt.stat1", unique_event) |
      #   
      # # just_form_hr_stat2 variables
      # grepl("McsdCardiacIndexDt", unique_event) |
      # grepl("McsdCapWedgePressureDt", unique_event) |
      # grepl("McsdSystolicBloodPressureDt", unique_event) |
      # grepl("McsdWithoutHemoCprDt", unique_event) |
      # grepl("McsdWithoutHemoSbpDt", unique_event) |
      # grepl("McsdWithoutHemoArtLacDt", unique_event) |
      # grepl("McsdWithoutHemoAstDt", unique_event) |
      # grepl("McsdWithoutHemoAltDt", unique_event) |
      # grepl("IabpCardiacIndexDt", unique_event) |
      # grepl("IabpCapWedgePressureDt", unique_event) |
      # grepl("IabpSystolicBloodPressureDt", unique_event) |
      # grepl("IabpWithoutHemoCprDt", unique_event) |
      # grepl("IabpWithoutHemoSbpDt", unique_event) |
      # grepl("IabpWithoutHemoArtLacDt", unique_event) |
      # grepl("IabpWithoutHemoAstDt", unique_event) |
      # grepl("IabpWithoutHemoAltDt", unique_event) |
      # grepl("ExtMeanPressureDt.stat2", unique_event) |
      # grepl("ExtCardiacIndexDt.stat2", unique_event) |
      # grepl("ExtCapWedgePressureDt.stat2", unique_event) |
      # grepl("ExtSvo2Dt.stat2", unique_event) |
      # 
      # # just_form_hr_stat3 variables
      # grepl("InoCardiacIndexDt", unique_event) |
      # grepl("InoCapWedgePressureDt", unique_event) |
      # grepl("InoSysBloodPressureDt", unique_event) |
      # grepl("McsdWithRhfDobutamineDt", unique_event) |
      # grepl("McsdWithRhfDopamineDt", unique_event) |
      # grepl("McsdWithRhfEpinephrineDt", unique_event) |
      # grepl("McsdWithRhfMilrinoneDt", unique_event) |
      # grepl("McsdWithRhfNitricOxideDt", unique_event) |
      # grepl("McsdWithRhfProstacyclinDt", unique_event) |
      # grepl("McsdWithRhfPcwpDt", unique_event) |
      # grepl("McsdWithRhfVenPressureDt", unique_event) |
      # grepl("ExtMcsdDobutamineDt", unique_event) |
      # grepl("ExtMcsdDopamineDt", unique_event) |
      # grepl("ExtMcsdEpinephrineDt", unique_event) |
      # grepl("ExtMcsdMilrinoneDt", unique_event) |
      # grepl("ExtMcsdNitricOxideDt", unique_event) |
      # grepl("ExtMcsdProstacyclinDt", unique_event) |
      # 
      # # just_form_hr_stat4 variables
      # grepl("InotropeCardiacIndexDt", unique_event) |
      # grepl("InotropePcwpDt", unique_event) |
      # 
      # # risk_strat_data_hr variables
      # grepl("CPTestDt", unique_event) |
      # grepl("SenDataDt", unique_event) |
      # grepl("HemoDt", unique_event) |
      # grepl("VadLdhLevelsDt", unique_event) |
      # grepl("VadPlasmaFreeHemoDt", unique_event) |
      # grepl("HrSevFailSodiumDt", unique_event) |
      # grepl("HrSevFailCreatinineDt", unique_event) |
      # grepl("HrSevFailBunDt", unique_event) |
      # grepl("HrSevFailAlbuminDt", unique_event) |
      # grepl("HrSevFailAsparTransDt", unique_event) |
      # grepl("HrSevFailBilirubinDt", unique_event) |
      # grepl("HrSevFailArterialLactDt", unique_event) |
      # grepl("HrSevFailInrDt", unique_event) |
      # grepl("HrSevFailBnpDt", unique_event) |
      # 
      # # stat_just_hr1a and stat_just_hr1b variables
      # grepl("CANHX_CHG_DT", unique_event) |
      # grepl("CANHX_VAD_IMPLANT_DT", unique_event) |
      # grepl("CANHX_LVAD_DT", unique_event) |
      # grepl("CANHX_RVAD_DT", unique_event) |
      # grepl("CANHX_TAH_DT", unique_event) |
      # grepl("CANHX_IABP_DT", unique_event) |
      # grepl("CANHX_ECMO_DT", unique_event) |
      # grepl("CANHX_DEV_INFECT_VAD_DT", unique_event) |
      # grepl("CANHX_MECH_VENT_DT", unique_event) |
      # grepl("CANHX_HEMO_DT", unique_event) |
      # grepl("CANHX_CARD_LAST_SCD_DT", unique_event) |
      # grepl("CANHX_LAB_DT", unique_event) |
      # grepl("CANHX_PHYS_VITALS_DT", unique_event) |
      # grepl("CANHX_PHYS_HEMO_DT", unique_event) |
      # grepl("CANHX_PHYS_ECHO_DT", unique_event) |
      # grepl("CANHX_MED_UPDATE_DT", unique_event))
  
```

# 9. Calculating number of days between each observation 
#    in full_list and final_list, by PX_ID

```{r calculate time steps}

final_list <- final_list %>%
  ungroup() %>% 
  mutate(t_start = 0, t_stop = 0) %>% 
  arrange(PX_ID, unique_date)

for (i in 2:nrow(final_list)) {
  if (final_list$PX_ID[[i]] == 
      final_list$PX_ID[[i-1]]) {
    
    final_list$t_stop[[i-1]] = 
      final_list$unique_date[[i]] - 
      final_list$unique_date[[i-1]] +
      final_list$t_start[[i-1]]
    
    final_list$t_start[[i]] = final_list$t_stop[[i-1]]
    
  } else {
    
    final_list$t_stop[[i-1]] = 
      final_list$t_start[[i-1]]
    
    final_list$t_start[[i]] = 0
      
  }
}

final_list <- final_list %>% 
  relocate(t_start, t_stop, .after = unique_date)

rdata_filename <-  paste0("status_changes_", curr_data_release, ".RData")

csv_filename <-  paste0("status_changes_", curr_data_release, ".csv")

save(final_list, file = rdata_filename)
write_csv(final_list, file = csv_filename)

# repeat process for full_list
full_list <- full_list %>%
  ungroup() %>% 
  mutate(t_start = 0, t_stop = 0) %>% 
  arrange(PX_ID, unique_date)

for (i in 2:nrow(full_list)) {
  if (full_list$PX_ID[[i]] == 
      full_list$PX_ID[[i-1]]) {
    
    full_list$t_stop[[i-1]] = 
      full_list$unique_date[[i]] - 
      full_list$unique_date[[i-1]] +
      full_list$t_start[[i-1]]
    
    full_list$t_start[[i]] = full_list$t_stop[[i-1]]
    
  } else {
    
    full_list$t_stop[[i-1]] = 
      full_list$t_start[[i-1]]
    
    full_list$t_start[[i]] = 0
      
  }
}

full_list <- full_list %>% 
  relocate(t_start, t_stop, .after = unique_date)

rdata_filename <-  paste0("full_list_", curr_data_release, ".RData")

csv_filename <-  paste0("full_list_", curr_data_release, ".csv")

save(full_list, file = rdata_filename)
write_csv(full_list, file = csv_filename)

end_time <- Sys.time()
end_time - start_time
```
