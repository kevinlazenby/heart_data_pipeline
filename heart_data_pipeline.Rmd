---
title: "heart_data_pipeline"
author: "Kevin Lazenby"
date: "12/21/2021"
output:
  pdf_document:
    toc: yes
    toc_depth: '2'
  html_notebook:
    theme: journal
    toc: yes
    toc_depth: 2
    toc_float: yes
---

# Setup

```{r setup, include=FALSE}

library(knitr)
opts_chunk$set(comment = NA, prompt = FALSE, cache = FALSE, echo = TRUE,
                      results = "asis")

library(tidyverse)
library(haven)
library(rmdformats)
library(dplyr)
library(tidyr)
library(ggpubr)
library(here)
library(readr)
library(lubridate)
library(boxr)
library(zoo)

here::i_am("heart_data_pipeline.Rmd")
```

# 1. Import data sets from SRTR

```{r load data}

# change this variable to load in a different release of the SAF
curr_data_release <- "pubsaf2103"

cand_thor <- read_sas(here(curr_data_release, "cand_thor.sas7bdat"), NULL) %>%  
  zap_formats() %>% zap_labels()

tx_hr <- read_sas(here(curr_data_release, "tx_hr.sas7bdat"), NULL) %>%  
  zap_formats() %>% zap_labels()

stathist_thor <- 
  read_sas(here(curr_data_release, "stathist_thor.sas7bdat"), NULL) %>%  
  zap_formats() %>% zap_labels()

stat_just_hr1a <- read_sas(here(curr_data_release, "statjust_hr1a.sas7bdat"), NULL) %>%  
  zap_formats() %>% zap_labels()

stat_just_hr1b <- read_sas(here(curr_data_release, "statjust_hr1b.sas7bdat"), NULL) %>%  
  zap_formats() %>% zap_labels()

just_form_hr <- read_sas(here(curr_data_release, "JustFormHR.sas7bdat"), NULL) %>%  
  zap_formats() %>% zap_labels()

just_form_hr_data_link <- 
  read_sas(here(curr_data_release, "JustFormHRDataLink.sas7bdat"), NULL) %>%  
  zap_formats() %>% zap_labels()

just_form_hr_stat1 <- 
  read_sas(here(curr_data_release, "JustFormHRStat1.sas7bdat"), NULL) %>%  
  zap_formats() %>% zap_labels()

just_form_hr_stat2 <- 
  read_sas(here(curr_data_release, "JustFormHRStat2.sas7bdat"), NULL) %>%  
  zap_formats() %>% zap_labels()

just_form_hr_stat3 <- 
  read_sas(here(curr_data_release, "JustFormHRStat3.sas7bdat"), NULL) %>%  
  zap_formats() %>% zap_labels()

just_form_hr_stat4 <- 
  read_sas(here(curr_data_release, "JustFormHRStat4.sas7bdat"), NULL) %>%  
  zap_formats() %>% zap_labels()

risk_strat_data_hr <- 
  read_sas(here(curr_data_release, "RiskStratDataHR.sas7bdat"), NULL) %>%  
  zap_formats() %>% zap_labels()

status_just_episode <- 
  read_sas(here(curr_data_release, "StatusJustEpisode.sas7bdat"), NULL) %>%
  zap_formats() %>% zap_labels()

thor_support_device <- 
  read_sas(here(curr_data_release, "ThorSupportDevice.sas7bdat"), NULL) %>% 
  zap_formats() %>% zap_labels()

column_descriptions <- 
  read_sas(here(curr_data_release, "ColumnDescriptions.sas7bdat"), NULL) %>%  
  zap_formats() %>% zap_labels()

table_descriptions <- 
  read_sas(here(curr_data_release, "TableDescriptions.sas7bdat"), NULL) %>%  
  zap_formats() %>% zap_labels()
```

# 2. Link data sets using JustId, WlregAuditId, and PX_ID
#     a. common linking variable after this block is PX_ID

```{r link data sets}

risk_strat_data_hr <- risk_strat_data_hr %>% 
  full_join(just_form_hr_data_link, by = c("WlregAuditId", "ChangeDate"))

just_form_hr_data_link <- just_form_hr_data_link %>% 
  full_join(risk_strat_data_hr %>% 
              select(WlregAuditId, JustId, ChangeDate, px_id),
            by = c("WlregAuditId", "JustId", "ChangeDate")) %>% 
  mutate(PX_ID = px_id) %>% 
  select(-px_id)

just_form_hr <- just_form_hr %>% select(-ChangeDate) %>% 
  full_join(just_form_hr_data_link %>% select(-ChangeDate), by = "JustId") %>%
  
  # join status episode information by JustId
  full_join(status_just_episode %>% select(JustId:EndDate), by = "JustId")  
  
  # device info appears to be full of duplicates and errors
  # # join device information by DeviceId
  # left_join(thor_support_device %>% select(DeviceId:OtherSpecify),
  #           by = c("ThorSupportDevicePrimary" = "DeviceId")) %>% 
  
  # # can pipe in this code to include secondary VADs
  # left_join(thor_support_device %>% select(DeviceId:OtherSpecify),
  #           by = c("ThorSupportDeviceSecondary" = "DeviceId"),
  #           suffix = c(".primary", ".secondary"))

just_form_hr_stat1 <- just_form_hr_stat1 %>% 
  left_join(just_form_hr_data_link %>% select(JustId, PX_ID), by = "JustId")

just_form_hr_stat2 <- just_form_hr_stat2 %>% 
  left_join(just_form_hr_data_link %>% select(JustId, PX_ID), by = "JustId")

just_form_hr_stat3 <- just_form_hr_stat3 %>% 
  left_join(just_form_hr_data_link %>% select(JustId, PX_ID), by = "JustId")

just_form_hr_stat4 <- just_form_hr_stat4 %>% 
  left_join(just_form_hr_data_link %>% select(JustId, PX_ID), by = "JustId")

```


# 3. Tidy input datasets
#     a. Filter out candidates listed before filter date
#     b. Filter out pediatric transplant candidates
#     c. Filter out lung-only transplant candidates

```{r apply exclusion criteria}

# change these variables to customize inclusion criteria
filter_date <- mdy("10/18/2018")
include_multi_organ_recipients <- TRUE
missingness_threshold <- 1

# filter candidates based on inclusion/exclusion criteria 
cand_list <- cand_thor %>% 
  filter(CAN_LISTING_DT >= filter_date) %>% 
  filter(WL_ORG != "LU") %>% 
  filter(CAN_AGE_AT_LISTING > 17)

if (include_multi_organ_recipients == FALSE) {
  multi_organ_recipients <- tx_hr %>% 
  filter(REC_TX_TY == 2 | REC_TX_TY == 4) %>% 
	select(PX_ID, REC_TX_TY)
  
  cand_list <- cand_list %>% 
    filter(CAN_INIT_STAT != 2150) %>% 
    filter(!(PX_ID %in% multi_organ_recipients$PX_ID))
}

# filter tx_hr
tx_list <- tx_hr %>% filter(PX_ID %in% cand_list$PX_ID)

# filter risk stratification data
risk_strat <- risk_strat_data_hr %>% 
  mutate(PX_ID = px_id) %>% select(-px_id) %>%
  filter(PX_ID %in% cand_list$PX_ID)

# filter status history file
stathist <- stathist_thor %>% filter(PX_ID %in% cand_list$PX_ID)

# filter common justification form file
just_form <- just_form_hr %>% filter(PX_ID %in% cand_list$PX_ID)

# filter data linking dataframe
data_link <- just_form_hr_data_link %>% filter(PX_ID %in% cand_list$PX_ID)

# filter Status 1A justification forms
just_stat1a <- stat_just_hr1a %>% filter(PX_ID %in% cand_list$PX_ID)

# filter Status 1B justification forms
just_stat1b <- stat_just_hr1b %>% filter(PX_ID %in% cand_list$PX_ID)

# filter Status 1 justification forms
just_stat1 <- just_form_hr_stat1 %>% filter(PX_ID %in% cand_list$PX_ID)

# filter Status 2 (new policy) justification forms
just_stat2 <- just_form_hr_stat2 %>% filter(PX_ID %in% cand_list$PX_ID)

# filter Status 3 justification forms
just_stat3 <- just_form_hr_stat3 %>% filter(PX_ID %in% cand_list$PX_ID)

# filter Status 4 justification forms
just_stat4 <- just_form_hr_stat4 %>% filter(PX_ID %in% cand_list$PX_ID)

rm(cand_thor, tx_hr, risk_strat_data_hr, stathist_thor, just_form_hr,
   stat_just_hr1a, stat_just_hr1b, just_form_hr_stat1, just_form_hr_stat2,
   just_form_hr_stat3, just_form_hr_stat4, thor_support_device,
   status_just_episode, just_form_hr_data_link)

```

# 4. Pivot cand_list and tx_list by date, then full_join to create full_list

```{r}

# this block selects the 47 variables in cand_thor currently used in analysis
cand_list <- cand_list %>% 
  select(
    PX_ID, WL_ORG, CAN_GENDER, CAN_ABO, CAN_RACE, PERS_SSA_DEATH_DT,
    PERS_OPTN_DEATH_DT, PERS_RESTRICT_DEATH_DT, CAN_LISTING_DT, CAN_REM_DT,
    CAN_REM_CD, CAN_DGN, CAN_ECMO, CAN_VENTILATOR, CAN_IABP, CAN_IV_INOTROP,
    CAN_VAD_TY, CAN_VAD1, CAN_PRIMARY_PAY, CAN_HGT_CM, CAN_WGT_KG, CAN_BMI,
    CAN_DIAB_TY, CAN_DIAL, CAN_CEREB_VASC, CAN_MOST_RECENT_CREAT,
    CAN_TOT_ALBUMIN, CAN_IMPLANT_DEFIB, CAN_PULM_ART_MEAN, CAN_PCW_MEAN,
    CAN_CARDIAC_OUTPUT, CAN_HIST_CIGARETTE, CAN_MALIG, CAN_LAST_STAT,
    CAN_AGE_IN_MONTHS_AT_LISTING, CAN_LAST_ACT_STAT_DT, CAN_LAST_INACT_STAT_DT,
    CAN_INIT_STAT, CAN_ANGINA, CAN_ANGINA_CAD, CAN_PEPTIC_ULCER, 
    CAN_EXERCISE_O2, CAN_DRUG_TREAT_HYPERTEN, CAN_PERIPH_VASC, CAN_ANTI_ARRYTHM,
    CAN_OTHER_TOBACCO_USE, CAN_PULM_EMBOL)

cand_list_missing_data_check <- tibble(
  pct_missing = vector(mode = "double", length = ncol(cand_list)),
  var_names = colnames(cand_list))

for (i in 1:ncol(cand_list)) {
  
  cand_list_missing_data_check$pct_missing[i] <-
    sum(is.na(cand_list[, i])) / nrow(cand_list)
}

cand_list_missing_data_check <- cand_list_missing_data_check %>% 
  filter(pct_missing >= missingness_threshold) %>% 
  arrange(desc(pct_missing))

# this line removes variables which do not meet missingness criteria
cand_list <- cand_list %>% select(-cand_list_missing_data_check$var_names)

cand_list <- cand_list %>%
  distinct() %>% 
  pivot_longer(cols = ends_with("DT"),
               names_to = "event", 
               values_to = "date", 
               values_drop_na = TRUE) %>%
  arrange(date) %>% 
  group_by(date) %>% 
  mutate(unique_date = date) %>%
  group_by(PX_ID, date) %>% 
  mutate(unique_event = str_c(event, collapse = ",")) %>% 
  pivot_wider(names_from = event, values_from = date) %>% 
  arrange(PX_ID, unique_date) %>% 
  ungroup() %>%
  select(PX_ID, unique_event, unique_date, 
         WL_ORG:CAN_PULM_EMBOL)

# repeat the same process as above with tx_list dataset
tx_list <- tx_list %>% 
  distinct() %>% 
  select(PX_ID, ORG_TY, REC_TX_DT, REC_POSTX_LOS, REC_A_MM_EQUIV_TX,
                     REC_B_MM_EQUIV_TX, REC_DR_MM_EQUIV_TX, REC_DGN, REC_CTR_CD,
                     REC_CTR_TY, REC_PX_STAT, REC_PX_STAT_DT,
                     REC_DISCHRG_DT, REC_ADMISSION_DT, REC_MED_COND, 
                     REC_FUNCTN_STAT, REC_PRIMARY_PAY, REC_HGT_CM, REC_WGT_KG,
                     REC_BMI, REC_HIV_STAT, REC_CMV_STAT, REC_HCV_STAT,
                     REC_EBV_STAT, REC_LIFE_SUPPORT, REC_ECMO,
                     REC_IABP, REC_PGE, REC_INOTROP, REC_VENTILATOR, REC_VAD1,
                     REC_VAD2, REC_CREAT, REC_TOT_BILI, REC_CHRONIC_STEROIDS,
                     REC_TXFUS, REC_INFECT_IV_DRUG, REC_DIAL, 
                     REC_VENTILATOR_SUPPORT, REC_HR_ISCH, REC_POSTX_STROKE,
                     REC_POSTX_DIAL, REC_POSTX_PACEMAKER,
                     REC_ACUTE_REJ_EPISODE, REC_CTR_ID, REC_AGE_IN_MONTHS_AT_TX,
                     REC_A1, REC_A2, REC_B1, REC_B2, REC_DR1, REC_DR2,
                     TFL_LASTATUS, TFL_GRAFT_DT, TFL_DEATH_DT, PERS_RETX,
                     TFL_LAFUDATE, REC_MM_EQUIV_TX)

tx_list_missing_data_check <- tibble(
  pct_missing = vector(mode = "double", length = ncol(tx_list)),
  var_names = colnames(tx_list))

for (i in 1:ncol(tx_list)) {
  
  tx_list_missing_data_check$pct_missing[i] <-
    sum(is.na(tx_list[, i])) / nrow(tx_list)
}

tx_list_missing_data_check <- tx_list_missing_data_check %>% 
  filter(pct_missing >= missingness_threshold) %>% 
  arrange(desc(pct_missing))

# this line removes variables which do not meet missingness criteria
tx_list <- tx_list %>% select(-tx_list_missing_data_check$var_names)


tx_list <- tx_list %>% 
  mutate(TFL_LAST_FU_DT = TFL_LAFUDATE) %>%
  select(-TFL_LAFUDATE) %>% 
  pivot_longer(cols = ends_with("DT"),
               names_to = "event", 
               values_to = "date", 
               values_drop_na = TRUE) %>%
  arrange(date) %>% 
  group_by(date) %>% 
  mutate(unique_date = date) %>%
  group_by(PX_ID, date) %>% 
  mutate(unique_event = str_c(event, collapse = ",")) %>% 
  pivot_wider(names_from = event, values_from = date) %>% 
  arrange(PX_ID, unique_date) %>% 
  ungroup() %>% 
  select(PX_ID, unique_event, unique_date, ORG_TY:REC_MM_EQUIV_TX)

full_list <- cand_list %>% 
  
  # full join by common variables, thus no need for suffix
  full_join(tx_list, by = c("PX_ID", "unique_date", "unique_event")) %>% 
  
  # combines events if events in cand_list and tx_list happened on the same day
  group_by(PX_ID, unique_date) %>% 
  mutate(unique_event = str_c(unique_event, collapse = ",")) %>% 
  
  # removes redundant rows after combining events above
  group_by(PX_ID, unique_date) %>% 
  fill(WL_ORG:REC_MM_EQUIV_TX, .direction = "downup") %>% 
  distinct() %>% 
  
  # fills in missing values for each candidate, since all vars in cand_list and
  # tx_list do not have multiple values across time
  group_by(PX_ID) %>% 
  fill(WL_ORG:REC_MM_EQUIV_TX, .direction = "downup") %>%
  
  # arranges dataset for easy viewing
  arrange(PX_ID, unique_date) %>% 
  ungroup()
  
```

# 5. Pivot stathist by date, then join with full_list

```{r pivot stathist_thor}

stathist <- stathist %>% 
  select(PX_ID, CANHX_BEGIN_DT, CANHX_STAT_CD, 
         CANHX_REASON_STAT_INACT) %>% 
  pivot_longer(cols = ends_with("DT"),
               names_to = "event", 
               values_to = "date", 
               values_drop_na = TRUE) %>%
  arrange(date) %>% 
  group_by(date) %>% 
  mutate(unique_date = date) %>%
  group_by(PX_ID, date) %>% 
  mutate(unique_event = str_c(event, collapse = ",")) %>% 
  pivot_wider(names_from = event, values_from = date) %>%
  arrange(PX_ID, unique_date) %>% 
  ungroup() %>%
  select(PX_ID, unique_event, unique_date, CANHX_STAT_CD, 
         CANHX_REASON_STAT_INACT)

full_list <- full_list %>% 
  
  # full join by common variables, thus no need for suffix
  full_join(stathist, by = c("PX_ID", "unique_date", "unique_event")) %>% 
  
  # combines events if events happened on the same day
  group_by(PX_ID, unique_date) %>%
  mutate(unique_event = str_c(unique_event, collapse = ",")) %>%

  # removes redundant rows after combining events above
  group_by(PX_ID, unique_date) %>%
  fill(WL_ORG:CANHX_REASON_STAT_INACT, .direction = "downup") %>%
  distinct() %>%
  
  # fills in missing values for each candidate, since all vars in cand_list and
  # tx_list do not have multiple values across time
  group_by(PX_ID) %>% 
  fill(WL_ORG:REC_MM_EQUIV_TX, .direction = "downup") %>%

  # fills in missing status code for each candidate, but only fills down to 
  # preserve changes in status over time (similar/same mechanism as na.locf)
  group_by(PX_ID) %>%
  fill(CANHX_STAT_CD, .direction = "down") %>%
  
  # arranges dataset for easy viewing
  arrange(PX_ID, unique_date) %>% 
  ungroup()

```

# 6. Join just forms with risk strat data, pivot combined dataset by date, then join with full_list

```{r pivot just_form_hr}

just_form <- just_form %>% 
  distinct(across(-JustId), .keep_all = TRUE) %>%
  mutate(status_description = descrip, BeginDt = BeginDate, EndDt = EndDate) %>%
  select(-descrip, -BeginDate, -EndDate, -EndDt, -ChangeDate) %>% 
  select(PX_ID, JustId, RequestedCandStatCd, ExtensionNumber, Exception,
         status_description:last_col())

just_stat1 <- just_stat1 %>% 
  distinct(across(-JustId), .keep_all = TRUE) %>%
  select(-ChangeDate)

just_stat2 <- just_stat2 %>% 
  distinct(across(-JustId), .keep_all = TRUE) %>%
  select(-ChangeDate)

just_stat3 <- just_stat3 %>% 
  distinct(across(-JustId), .keep_all = TRUE) %>%
  select(-ChangeDate)

just_stat4 <- just_stat4 %>% 
  distinct(across(-JustId), .keep_all = TRUE) %>%
  select(-ChangeDate)

risk_strat <- risk_strat %>% 
  distinct(across(-WlregAuditId), .keep_all = TRUE) %>%
  select(-ChangeDate, ChangeUserId, ChangeRequestorId)

combined_just_forms <- just_form %>%
  full_join(risk_strat, by = "PX_ID")
  full_join(just_stat1, by = c("JustId", "PX_ID")) %>% 
  full_join(just_stat2, by = c("JustId", "PX_ID"),
            suffix = c(".stat1", ".stat2")) %>%
  full_join(just_stat3, by = c("JustId", "PX_ID"),
            suffix = c(".stat2", ".stat3")) %>% 
  full_join(just_stat4, by = c("JustId", "PX_ID"),
            suffix = c(".stat3", ".stat4")) %>% 
  
  pivot_longer(cols = ends_with("Dt"),
               names_to = "event", 
               values_to = "date", 
               values_drop_na = TRUE) %>%
  
  arrange(date) %>% 
  group_by(date) %>% 
  mutate(unique_date = date) %>%
  group_by(PX_ID, date) %>% 
  mutate(unique_event = str_c(event, collapse = ",")) %>% 
  pivot_wider(names_from = event, values_from = date) %>%
  arrange(PX_ID, unique_date) %>% 
  ungroup() %>%
  select(PX_ID, unique_event, unique_date, 
         RequestedCandStatCd:ExtInotropeDopamine)

full_list <- full_list %>% 
  
  # full join by common variables, thus no need for suffix
  full_join(combined_just_forms, by = c("PX_ID", "unique_date", "unique_event")) %>% 
  
  # combines events if events happened on the same day
  group_by(PX_ID, unique_date) %>%
  mutate(unique_event = str_c(unique_event, collapse = ",")) %>%

  # removes redundant rows after combining events above
  group_by(PX_ID, unique_date) %>%
  fill(WL_ORG:ExtInotropeDopamine, .direction = "downup") %>%
  distinct() %>%
  
  # arranges dataset for easy viewing
  arrange(PX_ID, unique_date) %>% 
  ungroup()

```

# 7. Pivot old policy justification forms by date, then join with full_list

```{r pivot old just forms}

# just_stat1a <- just_stat1a %>% 
#   
#   # include only completed forms (small minority are excluded by this step)
#   filter(CANHX_FORM_STAT == 4 | CANHX_FORM_STAT == 8) %>% 
#   
#   # remove duplicate forms
#   distinct(PX_ID, CANHX_CHG_DT, .keep_all = TRUE) %>% 
#   
#   select(PX_ID, CANHX_CHG_DT, CANHX_LAB_DT, CANHX_IABP_DT, CANHX_ECMO_DT, 
#          CANHX_LVAD_DT, CANHX_VAD_IMPLANT_DT, CANHX_TAH_DT, CANHX_RVAD_DT, 
#          CANHX_HEMO_DT, CAN_LISTING_CTR_ID, 
#          CANHX_STAT_CD, CANHX_STAT_TY, CANHX_FORM_STAT, 
# 	       CANHX_DIALYSIS, CANHX_LAB_SERUM_CREAT, CANHX_LAB_BILI,
# 	       CANHX_ADULT_CRITERIA_A, CANHX_ADULT_CRITERIA_B, 
#          CANHX_ADULT_CRITERIA_C, CANHX_ADULT_CRITERIA_D, 
#          CANHX_ADULT_CRITERIA_E, CANHX_INTRP_DOBU, CANHX_INTRP_DOPA, 
#          CANHX_INTRP_MILRIN, CANHX_ADMITTED, CANHX_IABP, CANHX_ECMO, 
#          CANHX_LVAD_TYPE, CANHX_VAD, CANHX_TAH, CANHX_RVAD_TYPE, 
#          CANHX_CARD_OUTPUT, CANHX_HEMO_CI, CANHX_HEMO_INTRP_OBTAINED, 
#          CANHX_HEMO_BSA, CANHX_HEMO_PCWP, CANHX_HEMO_MPAP,
# 	       CANHX_DEV_MALFUNCTN, CANHX_DEV_VENT_ARRYTHM) %>%
#   pivot_longer(cols = ends_with("DT"),
#                names_to = "event", 
#                values_to = "date", 
#                values_drop_na = TRUE) %>%
#   
#   arrange(date) %>% 
#   group_by(date) %>% 
#   mutate(unique_date = date) %>%
#   group_by(PX_ID, date) %>% 
#   mutate(unique_event = str_c(event, collapse = ",")) %>% 
#   pivot_wider(names_from = event, values_from = date) %>%
#   arrange(PX_ID, unique_date) %>% 
#   ungroup() %>%
#   select(PX_ID, unique_event, unique_date, 
#          CAN_LISTING_CTR_ID:last_col())
# 
# full_list <- full_list %>% 
#   
#   # full join by common variables, thus no need for suffix
#   full_join(just_stat1a, by = c("PX_ID", "unique_date", "unique_event")) %>% 
#   
#   # combines events if events happened on the same day
#   group_by(PX_ID, unique_date) %>%
#   mutate(unique_event = str_c(unique_event, collapse = ",")) %>%
# 
#   # removes redundant rows after combining events above
#   group_by(PX_ID, unique_date) %>%
#   fill(WL_ORG:CANHX_DEV_VENT_ARRYTHM, .direction = "downup") %>%
#   distinct() %>%
#   
#   # arranges dataset for easy viewing
#   arrange(PX_ID, unique_date) %>% 
#   ungroup()
# 
# # repeat the same process as above with just_stat1b
# just_stat1b <- just_stat1b %>% 
#   
#   # include only completed forms (small minority are excluded by this step)
#   filter(CANHX_FORM_STAT == 4 | CANHX_FORM_STAT == 8) %>% 
#   
#   # remove duplicate forms
#   distinct(PX_ID, CANHX_CHG_DT, .keep_all = TRUE) %>% 
#   
#   mutate(low_dose_inotrope = 
#            pmax(CANHX_REQUIRE_LOW_INOTROP, CANHX_CONT_IV_INOTROP)) %>% 
#   
#   select(PX_ID, CANHX_CHG_DT, CANHX_VAD_IMPLANT_DT, CAN_LISTING_CTR_ID, 
#          CANHX_STAT_CD, CANHX_VAD, CANHX_CRIT_NOT_MET, low_dose_inotrope) %>%
#   pivot_longer(cols = ends_with("DT"),
#                names_to = "event", 
#                values_to = "date", 
#                values_drop_na = TRUE) %>%
#   
#   arrange(date) %>% 
#   group_by(date) %>% 
#   mutate(unique_date = date) %>%
#   group_by(PX_ID, date) %>% 
#   mutate(unique_event = str_c(event, collapse = ",")) %>% 
#   pivot_wider(names_from = event, values_from = date) %>%
#   arrange(PX_ID, unique_date) %>% 
#   ungroup() %>%
#   select(PX_ID, unique_event, unique_date, 
#          CAN_LISTING_CTR_ID:last_col())
# 
# full_list <- full_list %>% 
#   
#   # full join by common variables, thus no need for suffix
#   full_join(just_stat1b, by = c("PX_ID", "unique_date", "unique_event")) %>% 
#   
#   # combines events if events happened on the same day
#   group_by(PX_ID, unique_date) %>%
#   mutate(unique_event = str_c(unique_event, collapse = ",")) %>%
# 
#   # removes redundant rows after combining events above
#   group_by(PX_ID, unique_date) %>%
#   fill(WL_ORG:last_col(), .direction = "downup") %>%
#   distinct() %>%
#   
#   # arranges dataset for easy viewing
#   arrange(PX_ID, unique_date) %>% 
#   ungroup()

```

# 8. Pivot new policy justification forms by date, then join with full_list

```{r pivot new just forms}

# just_stat1 <- just_stat1 %>% 
#   distinct(across(-JustId), .keep_all = TRUE) %>%
#   mutate(ChangeDt = ChangeDate) %>% 
#   pivot_longer(cols = ends_with("Dt"),
#                names_to = "event", 
#                values_to = "date", 
#                values_drop_na = TRUE) %>%
#   arrange(date) %>% 
#   group_by(date) %>% 
#   mutate(unique_date = date) %>%
#   group_by(PX_ID, date) %>% 
#   mutate(unique_event = str_c(event, collapse = ",")) %>% 
#   pivot_wider(names_from = event, values_from = date) %>%
#   mutate(
#     EcmoSystolicBloodPressure = case_when(!is.na(EcmoSystolicBloodPressureDt) ~
#                                             EcmoSystolicBloodPressure),
#     EcmoCardiacIndex = case_when(!is.na(EcmoCardiacIndexDt) ~
#                                    EcmoCardiacIndex),
#     EcmoCapWedgePressure = case_when(!is.na(EcmoCapWedgePressureDt) ~
#                                    EcmoCapWedgePressure),
#     EcmoWithoutHemoSbp = case_when(!is.na(EcmoWithoutHemoSbpDt) ~
#                                    EcmoWithoutHemoSbp),
#     EcmoWithoutHemoArtLac = case_when(!is.na(EcmoWithoutHemoArtLacDt) ~
#                                    EcmoWithoutHemoArtLac),
#     EcmoWithoutHemoAst = case_when(!is.na(EcmoWithoutHemoAstDt) ~
#                                    EcmoWithoutHemoAst),
#     EcmoWithoutHemoAlt = case_when(!is.na(EcmoWithoutHemoAltDt) ~
#                                    EcmoWithoutHemoAlt)) %>% 
#   arrange(PX_ID, unique_date) %>% 
#   ungroup() %>%
#   select(PX_ID, JustId, unique_event, unique_date, 
#          EcmoSystolicBloodPressure, EcmoCardiacIndex, 
#          EcmoCapWedgePressure, EcmoWithoutHemoSbp, EcmoWithoutHemoArtLac, 
#          EcmoWithoutHemoAst, EcmoWithoutHemoAlt)
# 
# just_stat2 <- just_stat2 %>% 
#   distinct(across(-JustId), .keep_all = TRUE) %>%
#   mutate(ChangeDt = ChangeDate) %>% 
#   pivot_longer(cols = ends_with("Dt"),
#                names_to = "event", 
#                values_to = "date", 
#                values_drop_na = TRUE) %>%
#   arrange(date) %>% 
#   group_by(date) %>% 
#   mutate(unique_date = date) %>%
#   group_by(PX_ID, date) %>% 
#   mutate(unique_event = str_c(event, collapse = ",")) %>% 
#   pivot_wider(names_from = event, values_from = date) %>%
#   mutate(
#     McsdCardiacIndex = case_when(!is.na(McsdCardiacIndexDt) ~ McsdCardiacIndex),
#     McsdCapWedgePressure = case_when(!is.na(McsdCapWedgePressureDt) ~ 
#                                        McsdCapWedgePressure),
#     McsdSystolicBloodPressure = case_when(!is.na(McsdSystolicBloodPressureDt) ~ 
#                                        McsdSystolicBloodPressure),
#     McsdWithoutHemoSbp = case_when(!is.na(McsdWithoutHemoSbpDt) ~ 
#                                        McsdWithoutHemoSbp),
#     McsdWithoutHemoArtLac = case_when(!is.na(McsdWithoutHemoArtLacDt) ~ 
#                                        McsdWithoutHemoArtLac),
#     McsdWithoutHemoAst = case_when(!is.na(McsdWithoutHemoAstDt) ~ 
#                                        McsdWithoutHemoAst),
#     IabpCardiacIndex = case_when(!is.na(IabpCardiacIndexDt) ~ 
#                                        IabpCardiacIndex),
#     IabpCapWedgePressure = case_when(!is.na(IabpCapWedgePressureDt) ~ 
#                                        IabpCapWedgePressure),
#     IabpSystolicBloodPressure = case_when(!is.na(IabpSystolicBloodPressureDt) ~ 
#                                        IabpSystolicBloodPressure),
#     IabpWithoutHemoSbp = case_when(!is.na(IabpWithoutHemoSbpDt) ~ 
#                                        IabpWithoutHemoSbp),
#     IabpWithoutHemoArtLac = case_when(!is.na(IabpWithoutHemoArtLacDt) ~ 
#                                        IabpWithoutHemoArtLac),
#     IabpWithoutHemoAst = case_when(!is.na(IabpWithoutHemoAstDt) ~ 
#                                        IabpWithoutHemoAst),
#     IabpWithoutHemoAlt = case_when(!is.na(IabpWithoutHemoAltDt) ~ 
#                                        IabpWithoutHemoAlt)) %>% 
#   arrange(PX_ID, unique_date) %>% 
#   ungroup() %>%
#   select(PX_ID, JustId, unique_event, unique_date, McsdCardiacIndex, 
#          McsdCapWedgePressure, McsdSystolicBloodPressure, McsdWithoutHemoSbp, 
#          McsdWithoutHemoArtLac, McsdWithoutHemoAst, 
#          IabpCardiacIndex, IabpCapWedgePressure, IabpSystolicBloodPressure,
#          IabpWithoutHemoSbp, IabpWithoutHemoArtLac, IabpWithoutHemoAst,
#          IabpWithoutHemoAlt)
# 
# just_stat3 <- just_stat3 %>% 
#   distinct(across(-JustId), .keep_all = TRUE) %>%
#   mutate(
#     ChangeDt = ChangeDate) %>% 
#   pivot_longer(cols = ends_with("Dt"),
#                names_to = "event", 
#                values_to = "date", 
#                values_drop_na = TRUE) %>%
#   arrange(date) %>% 
#   group_by(date) %>% 
#   mutate(unique_date = date) %>%
#   group_by(PX_ID, date) %>% 
#   mutate(unique_event = str_c(event, collapse = ",")) %>% 
#   pivot_wider(names_from = event, values_from = date) %>%
#   mutate(
#     InoCardiacIndex = case_when(!is.na(InoCardiacIndexDt) ~ InoCardiacIndex),
#     InoCapWedgePressure = case_when(!is.na(InoCapWedgePressureDt) ~ 
#                                       InoCapWedgePressure),
#     InoSysBloodPressure = case_when(!is.na(InoSysBloodPressureDt) ~ 
#                                       InoSysBloodPressure),
#     McsdWithRhfPcwp = case_when(!is.na(McsdWithRhfPcwpDt) ~ 
#                                       McsdWithRhfPcwp),
#     McsdWithRhfVenPressure = case_when(!is.na(McsdWithRhfVenPressureDt) ~ 
#                                       McsdWithRhfVenPressure)) %>% 
#   arrange(PX_ID, unique_date) %>% 
#   ungroup() %>%
#   select(PX_ID, JustId, unique_event, unique_date, InoCardiacIndex,
#          InoCapWedgePressure, InoSysBloodPressure, McsdLactateDehydrogenase,
#          McsdPlasmaFreeHemoglobin, McsdHemoglobinuria,
#          McsdWithPumpTransIscAttack, McsdWithRhfPcwp, McsdWithRhfVenPressure, 
#          MucosalBleedNumHosp)
# 
# just_stat4 <- just_stat4 %>%
#   distinct(across(-JustId), .keep_all = TRUE) %>% 
#   mutate(ChangeDt = ChangeDate) %>%
#   pivot_longer(cols = ends_with("Dt"),
#                names_to = "event", 
#                values_to = "date", 
#                values_drop_na = TRUE) %>%
#   arrange(date) %>% 
#   group_by(date) %>% 
#   mutate(unique_date = date) %>%
#   group_by(PX_ID, date) %>% 
#   mutate(unique_event = str_c(event, collapse = ",")) %>% 
#   pivot_wider(names_from = event, values_from = date) %>%
#   mutate(
#     InotropeCardiacIndex = case_when(!is.na(InotropeCardiacIndexDt) ~ 
#                                        InotropeCardiacIndex),
#     InotropePcwp = case_when(!is.na(InotropePcwpDt) ~ 
#                                        InotropePcwp)) %>% 
#   arrange(PX_ID, unique_date) %>% 
#   ungroup() %>%
#   select(PX_ID, JustId, unique_event, unique_date, 
#          InotropeCardiacIndex, InotropePcwp)
# 
# just_all_stat <- just_stat1 %>% 
#   full_join(just_stat2, by = c("PX_ID", "unique_event", "unique_date", "JustId")) %>%
#   full_join(just_stat3, by = c("PX_ID", "unique_event", "unique_date", "JustId")) %>%
#   full_join(just_stat4, by = c("PX_ID", "unique_event", "unique_date", "JustId"))
#   
# # full join on common variables
# full_list <- full_list %>% 
#   full_join(just_all_stat, by = c("PX_ID", "unique_event", "unique_date")) %>% 
#   
#   # # justification forms have date-times instead of dates, so converting to date
#   # mutate(unique_date = floor_date(unique_date, unit = "day")) %>%
#   
#   # # TODO: fix bug that does not combine all events (see PX_ID = 1238278, 1238293)
#   # # combines events if events happened on the same day
#   group_by(PX_ID, unique_date) %>%
#   mutate(unique_event = str_c(unique_event, collapse = ",")) %>%
# 
#   # removes redundant rows after combining events above
#   group_by(PX_ID, unique_date) %>%
#   fill(WL_ORG:last_col(), .direction = "downup") %>%
#   distinct() %>%
#   
#   # arranges dataset by PX_ID and event date for easy viewing
#   arrange(PX_ID, unique_date) %>% 
#   ungroup()
```

# 9. Pivot risk stratification data by date, then join with full_list

```{r pivot risk strat data}
risk_strat <- risk_strat %>%
  mutate(ChangeDt = ChangeDate) %>%
  pivot_longer(cols = ends_with("Dt"),
               names_to = "event", 
               values_to = "date", 
               values_drop_na = TRUE) %>%
  
  group_by(date) %>% 
  mutate(unique_date = date) %>%
  group_by(PX_ID, date) %>% 
  mutate(unique_event = str_c(event, collapse = ",")) %>% 
  pivot_wider(names_from = event, values_from = date) %>% 
  mutate(
    CPTestMvo2 = case_when(!is.na(CPTestDt) ~ CPTestMvo2),
    CPTestRer = case_when(!is.na(CPTestDt) ~ CPTestRer),
    CPTestVeVco2 = case_when(!is.na(CPTestDt) ~ CPTestVeVco2),
    SenDataCpra = case_when(!is.na(SenDataDt) ~ SenDataCpra),
    SenDataMfiThreshold = case_when(!is.na(SenDataDt) ~ SenDataMfiThreshold),
    HemoObtainedOnSupport = case_when(!is.na(HemoDt) ~ HemoObtainedOnSupport),
    HemoSbp = case_when(!is.na(HemoDt) ~ HemoSbp),
    HemoDbp = case_when(!is.na(HemoDt) ~ HemoDbp),
    HemoRestingHeartRate = case_when(!is.na(HemoDt) ~ HemoRestingHeartRate),
    HemoCvp = case_when(!is.na(HemoDt) ~ HemoCvp),
    HemoPasp = case_when(!is.na(HemoDt) ~ HemoPasp),
    HemoPadp = case_when(!is.na(HemoDt) ~ HemoPadp),
    HemoMeanPressure = case_when(!is.na(HemoDt) ~ HemoMeanPressure),
    HemoPcwp = case_when(!is.na(HemoDt) ~ HemoPcwp),
    HemoLvedp = case_when(!is.na(HemoDt) ~ HemoLvedp),
    HemoCardiacOutput = case_when(!is.na(HemoDt) ~ HemoCardiacOutput),
    HemoCardiacIndex = case_when(!is.na(HemoDt) ~ HemoCardiacIndex),
    HemoSvo2 = case_when(!is.na(HemoDt) ~ HemoSvo2),
    HemoHemoglobin = case_when(!is.na(HemoDt) ~ HemoHemoglobin),
    VadLdhLevels = case_when(!is.na(VadLdhLevelsDt) ~ VadLdhLevels),
    VadPlasmaFreeHemo = case_when(!is.na(VadPlasmaFreeHemoDt) ~ VadPlasmaFreeHemo),
    HrSevFailSodium = case_when(!is.na(HrSevFailSodiumDt) ~ HrSevFailSodium),
    HrSevFailCreatinine = case_when(!is.na(HrSevFailCreatinineDt) ~ HrSevFailCreatinine),
    HrSevFailBun = case_when(!is.na(HrSevFailBunDt) ~ HrSevFailBun),
    HrSevFailAlbumin = case_when(!is.na(HrSevFailAlbuminDt) ~ HrSevFailAlbumin),
    HrSevFailAsparTrans = case_when(!is.na(HrSevFailAsparTransDt) ~ HrSevFailAsparTrans),
    HrSevFailBilirubin = case_when(!is.na(HrSevFailBilirubinDt) ~ HrSevFailBilirubin),
    HrSevFailArterialLact = case_when(!is.na(HrSevFailArterialLactDt) ~
                                        HrSevFailArterialLact),
    HrSevFailInr = case_when(!is.na(HrSevFailInrDt) ~ HrSevFailInr),
    HrSevFailInrAntiCoag = case_when(!is.na(HrSevFailInrDt) ~ HrSevFailInrAntiCoag),
    HrSevFailBnp = case_when(!is.na(HrSevFailBnpDt) ~ HrSevFailBnp)) %>%

  arrange(PX_ID, unique_date) %>% 
  ungroup() %>% 
  
  select(PX_ID, RiskStratId, ChangeDate, unique_date, unique_event, 
         CandHistNumSternotomies, CandHistStroke, CandHistThromb,
         CandHistNumHospAdmn, CurrTherOnLoopDiuretic, CurrTherVasoactiveSupport,
         CurrTherAntiArrhythmics, CurrTherPulVas, CurrTherOnDialysis,
         CurrTherMechVent, CPTestMvo2, CPTestRer, CPTestVeVco2, SenDataCpra, 
         SenDataMfiThreshold, HemoObtainedOnSupport, HemoSbp, HemoDbp,
         HemoRestingHeartRate, HemoCvp, HemoPasp, HemoPadp, HemoMeanPressure, 
         HemoPcwp, HemoLvedp, HemoCardiacOutput, HemoCardiacIndex, HemoSvo2,
         HemoHemoglobin, VadLdhLevels, VadPlasmaFreeHemo, VadHemoglobinuria, 
         HrSevFailSodium, HrSevFailCreatinine, HrSevFailBun, HrSevFailAlbumin, 
         HrSevFailAsparTrans, HrSevFailBilirubin, HrSevFailArterialLact, 
         HrSevFailInr, HrSevFailInrAntiCoag, HrSevFailBnp)  

full_list <- full_list %>% 
  
  # full join by common variables, thus no need for suffix
  full_join(risk_strat, by = c("PX_ID", "unique_date", "unique_event")) %>% 
  
  # combines events if events happened on the same day
  group_by(PX_ID, unique_date) %>%
  mutate(unique_event = str_c(unique_event, collapse = ",")) %>%

  # removes redundant rows after combining events above
  group_by(PX_ID, unique_date) %>%
  fill(WL_ORG:last_col(), .direction = "downup") %>%
  distinct() %>%
  
  # arranges dataset for easy viewing
  arrange(PX_ID, unique_date) %>% 
  ungroup()

```

# 10. Calculating number of days between each observation in full_list, by PX_ID

```{r}

# stat1_criteria = case_when(
#     CriteriaEcmoSupport == 1 ~ "Status 1: ECMO",
#     CriteriaBivadSupport == 1 ~ "Status 1: BiVAD",
#     CriteriaMcsdSupport == 1 ~ "Status 1: MCSD with ventricular arrhythmia",
#     TRUE ~ "Status 1: Exception"),

# stat2_criteria = case_when(
#     CriteriaLvadSupport == 1 ~ "Status 2: Non-dischargeable LVAD",
#     CriteriaDurableDevSupport == 1 ~ "Status 2: Durable VAD",
#     CriteriaMcsdMalfunction == 1 ~ "Status 2: MCSD malfunction",
#     CriteriaMcsdEndovasSupp == 1 ~ "Status 2: Endovascular MCSD",
#     CriteriaIabpSupport == 1 ~ "Status 2: IABP",
#     CriteriaVentEpisode == 1 ~ "Status 2: Ventricular episodes",
#     TRUE ~ "Status 2: Exception"),

# stat3_criteria = case_when(
#     CriteriaLvadDiscSupport == 1 ~ "Status 3: Dischargeable LVAD discretionary time",
#     CriteriaInotropeSupport == 1 ~ "Status 3: Inotropes with hemodynamic monitoring",
#     CriteriaMcsdWithHemo == 1 ~ "Status 3: MCSD with hemolysis",
#     CriteriaMcsdWithPump == 1 ~ "Status 3: MCSD with pump thrombosis",
#     CriteriaMcsdWithRhf == 1 ~ "Status 3: MCSD with RHF",
#     CriteriaMcsdInfection == 1 ~ "Status 3: MCSD with device infection",
#     CriteriaMcsdMucosalBleed == 1 ~ "Status 3: MCSD with bleeding",
#     CriteriaMcsdWithAI == 1 ~ "Status 3: MCSD with AI",
#     CriteriaVaEcmoSupport == 1 ~ "Status 3: ECMO after 7 days",
#     CriteriaLvadSupport == 1 ~ "Status 3: Non-dischargeable LVAD after 14 days",
#     CriteriaPercuSupport == 1 ~ "Status 3: Endovascular MCSD after 14 days",
#     CriteriaIabpSupport == 1 ~ "Status 3: IABP after 14 days",
#     TRUE ~ "Status 3: Exception"),

# stat4_criteria = case_when(
#     CriteriaLvadSupport == 1 ~ "Status 4: Dischargeable LVAD without discretionary time",
#     CriteriaInotropeSupport == 1 ~ "Status 4: Inotropes without hemodynamic monitoring",
#     CriteriaHeartDisease == 1 ~ "Status 4: Congenital heart disease",
#     CriteriaIschemicHeart == 1 ~ "Status 4: Ischemic heart disease with intractable angina",
#     CriteriaCardiomyopathy == 1 ~ "Status 4: Amyloidosis, HCM, or RCM",
#     CriteriaRetransplant == 1 ~ "Status 4: Re-transplant",
#     TRUE ~ "Status 4: Exception"),

  # mutate(status_criteria = coalesce(stat1_criteria,
  #                                   stat2_criteria,
  #                                   stat3_criteria,
  #                                   stat4_criteria)) %>%
  # mutate(status_criteria =
  #          ifelse(is.na(status_criteria), "Status 6", status_criteria)) %>%
  # select(-stat1_criteria, -stat2_criteria, -stat3_criteria, -stat4_criteria)

  # # fills status criteria from justification form to all rows within each
  # # group of PX_ID and JustId
  # group_by(PX_ID, JustId) %>% 
  # fill(status_criteria, .direction = "downup") %>% 
  # ungroup() %>% 

full_list <- full_list %>%
  ungroup() %>% 
  mutate(t_start = 0, t_stop = 0) %>% 
  arrange(PX_ID, unique_date)

for (i in 2:nrow(full_list)) {
  if (full_list$PX_ID[[i]] == 
      full_list$PX_ID[[i-1]]) {
    
    full_list$t_stop[[i-1]] = 
      full_list$unique_date[[i]] - 
      full_list$unique_date[[i-1]] +
      full_list$t_start[[i-1]]
    
    full_list$t_start[[i]] = full_list$t_stop[[i-1]]
    
  } else {
    
    full_list$t_stop[[i-1]] = 
      full_list$t_start[[i-1]]
    
    full_list$t_start[[i]] = 0
      
  }
}

full_list <- full_list %>% 
  select(PX_ID, unique_event, unique_date, t_start, t_stop, WL_ORG:last_col())

```
