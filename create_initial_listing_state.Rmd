---
title: "create_initial_listing_state"
author: "Kevin Lazenby"
date: "10/4/2021"
output:
  pdf_document:
    toc: yes
    toc_depth: '2'
  html_notebook:
    theme: journal
    toc: yes
    toc_depth: 2
    toc_float: yes
---

# Setup

```{r setup, include=FALSE}

library(knitr)
opts_chunk$set(comment = NA, prompt = FALSE, cache = FALSE, echo = TRUE,
                      results = "asis")

library(tidyverse)
library(haven)
library(rmdformats)
library(dplyr)
library(tidyr)
library(ggpubr)
library(here)
library(readr)
library(lubridate)
library(boxr)

here::i_am("create_initial_listing_state.Rmd")
```

# 1. Import data sets from SRTR

```{r}

curr_data_release <- "pubsaf2103"

cand_thor <- read_sas(here(curr_data_release, "cand_thor.sas7bdat"), NULL) %>%  
  zap_formats() %>% zap_labels()

cand_thor_selected_vars <- read_csv(here("cand_thor_selected_vars.csv"))
cand_thor_selected_vars <- pull(cand_thor_selected_vars)

stat_just_hr1a <- read_sas(here(curr_data_release, "statjust_hr1a.sas7bdat"), NULL) %>%  
  zap_formats() %>% zap_labels()

stat_just_hr1b <- read_sas(here(curr_data_release, "statjust_hr1b.sas7bdat"), NULL) %>%  
  zap_formats() %>% zap_labels()

just_form_hr <- read_sas(here(curr_data_release, "JustFormHR.sas7bdat"), NULL) %>%  
  zap_formats() %>% zap_labels()

just_form_hr_stat1 <- 
  read_sas(here(curr_data_release, "JustFormHRStat1.sas7bdat"), NULL) %>%  
  zap_formats() %>% zap_labels()

just_form_hr_stat2 <- 
  read_sas(here(curr_data_release, "JustFormHRStat2.sas7bdat"), NULL) %>%  
  zap_formats() %>% zap_labels()

just_form_hr_stat3 <- 
  read_sas(here(curr_data_release, "JustFormHRStat3.sas7bdat"), NULL) %>%  
  zap_formats() %>% zap_labels()

just_form_hr_stat4 <- 
  read_sas(here(curr_data_release, "JustFormHRStat4.sas7bdat"), NULL) %>%  
  zap_formats() %>% zap_labels()

risk_strat_data_hr <- 
  read_sas(here(curr_data_release, "RiskStratDataHR.sas7bdat"), NULL) %>%  
  zap_formats() %>% zap_labels()

just_form_hr_data_link <- 
  read_sas(here(curr_data_release, "JustFormHRDataLink.sas7bdat"), NULL) %>%  
  zap_formats() %>% zap_labels()

column_descriptions <- 
  read_sas(here(curr_data_release, "ColumnDescriptions.sas7bdat"), NULL) %>%  
  zap_formats() %>% zap_labels()

table_descriptions <- 
  read_sas(here(curr_data_release, "TableDescriptions.sas7bdat"), NULL) %>%  
  zap_formats() %>% zap_labels()

stathist_thor <- 
  read_sas(here(curr_data_release, "stathist_thor.sas7bdat"), NULL) %>%  
  zap_formats() %>% zap_labels()

status_just_episode <- 
  read_sas(here(curr_data_release, "StatusJustEpisode.sas7bdat"), NULL) %>%
  zap_formats() %>% zap_labels()

thor_support_device <- 
  read_sas(here(curr_data_release, "ThorSupportDevice.sas7bdat"), NULL) %>% 
  zap_formats() %>% zap_labels()

tx_hr <- read_sas(here(curr_data_release, "tx_hr.sas7bdat"), NULL) %>%  
  zap_formats() %>% zap_labels()
```

# 2. Link data sets using JustId, WlregAuditId, and PX_ID
#     a. common linking variable after this block is PX_ID

```{r link data sets}

just_form_hr_data_link <- just_form_hr_data_link %>% 
  left_join(risk_strat_data_hr %>%
              select(px_id, WlregAuditId), by = "WlregAuditId") %>% 
  mutate(PX_ID = px_id) %>% select(-px_id)

just_form_hr <- just_form_hr %>% 
  left_join(just_form_hr_data_link %>% select(JustId, PX_ID), by = "JustId")

just_form_hr_stat1 <- just_form_hr_stat1 %>% 
  left_join(just_form_hr_data_link %>% select(JustId, PX_ID), by = "JustId")

just_form_hr_stat2 <- just_form_hr_stat2 %>% 
  left_join(just_form_hr_data_link %>% select(JustId, PX_ID), by = "JustId")

just_form_hr_stat3 <- just_form_hr_stat3 %>% 
  left_join(just_form_hr_data_link %>% select(JustId, PX_ID), by = "JustId")

just_form_hr_stat4 <- just_form_hr_stat4 %>% 
  left_join(just_form_hr_data_link %>% select(JustId, PX_ID), by = "JustId")

```


# 3. Tidy input datasets
#     a. Filter out candidates listed before new policy implementation
#     b. Filter in adult, heart-only transplant candidates
#     c. Remove variables which are missing or irrelevant

```{r}
policy_switch_date <- mdy("10/18/2018")

multi_organ_recipients <- tx_hr %>% 
  filter(REC_TX_TY == 2 | REC_TX_TY == 4) %>% 
	select(PX_ID, REC_TX_TY)

# filter candidates based on inclusion/exclusion criteria to create initial listing state
init_list_post <- cand_thor %>% 
  filter(CAN_LISTING_DT >= policy_switch_date) %>% 
  filter(WL_ORG == "HR") %>% 
  filter(CAN_INIT_STAT != 2150) %>% 
  filter(CAN_AGE_AT_LISTING > 17) %>% 
  filter(!(PX_ID %in% multi_organ_recipients$PX_ID))

# risk stratification data from post-policy era
risk_strat_post <- risk_strat_data_hr %>% 
  mutate(PX_ID = px_id) %>% select(-px_id) %>%
  filter(PX_ID %in% init_list_post$PX_ID)

# status history file from post-policy era
stathist_post <- stathist_thor %>% filter(PX_ID %in% init_list_post$PX_ID)

# justification forms from post-policy era
just_form_post <- just_form_hr %>% filter(PX_ID %in% init_list_post$PX_ID)

# data linking dataframe from post-policy era
data_link_post <- just_form_hr_data_link %>% filter(PX_ID %in% init_list_post$PX_ID)

# Status 1 justification forms from post-policy era
just_stat1_post <- just_form_hr_stat1 %>% filter(PX_ID %in% init_list_post$PX_ID)

# Status 2 justification forms from post-policy era
just_stat2_post <- just_form_hr_stat2 %>% filter(PX_ID %in% init_list_post$PX_ID)

# Status 3 justification forms from post-policy era
just_stat3_post <- just_form_hr_stat3 %>% filter(PX_ID %in% init_list_post$PX_ID)

# Status 4 justification forms from post-policy era
just_stat4_post <- just_form_hr_stat4 %>% filter(PX_ID %in% init_list_post$PX_ID)

# this line selects the 46 variables in cand_thor currently used in analysis
init_list_post <- init_list_post %>% select(all_of(cand_thor_selected_vars))

missing_data_check <- tibble(
  pct_missing = vector(mode = "double", length = ncol(init_list_post)),
  var_names = colnames(init_list_post))

for (i in 1:ncol(init_list_post)) {
  
  missing_data_check$pct_missing[i] <-
    sum(is.na(init_list_post[, i])) / nrow(init_list_post)
}

missing_data_check <- missing_data_check %>% 
  filter(pct_missing == 1) %>% 
  arrange(desc(pct_missing))

# this line removes 4 variables from init_list_post which are completely missing
# Variable names: CAN_ANGINA, CAN_ANGINA_CAD, CAN_PEPTIC_ULCER, CAN_TOT_ALBUMIN
init_list_post <- init_list_post %>% select(-missing_data_check$var_names)
```

# 4. Add initial justification form for each candidate to init_list_post

```{r}
init_just_forms <- just_form_post %>% 
  group_by(PX_ID) %>% 
  slice_min(FormAddDt, with_ties = FALSE) %>% 
  ungroup()

just_stat1_post <- just_stat1_post %>% 
  mutate(stat1_criteria = case_when(
    CriteriaEcmoSupport == 1 ~ "Status 1: ECMO",
    CriteriaBivadSupport == 1 ~ "Status 1: BiVAD",
    CriteriaMcsdSupport == 1 ~ "Status 1: MCSD with ventricular arrhythmia",
    TRUE ~ "Status 1: Exception"))

init_list_post <- init_list_post %>% 
  left_join(just_stat1_post %>% 
              filter(PX_ID %in% init_just_forms$PX_ID) %>%
              group_by(PX_ID) %>% 
              slice_min(ChangeDate, with_ties = FALSE) %>% 
              ungroup() %>% 
              select(stat1_criteria, EcmoSystolicBloodPressure, 
                     EcmoCardiacIndex, EcmoCapWedgePressure, EcmoWithoutHemoSbp,
                     EcmoWithoutHemoArtLac, EcmoWithoutHemoAst,
                     EcmoWithoutHemoAlt, PX_ID), by = "PX_ID")

just_stat2_post <- just_stat2_post %>% 
  mutate(stat2_criteria = case_when(
    CriteriaLvadSupport == 1 ~ "Status 2: Non-dischargeable LVAD",
    CriteriaDurableDevSupport == 1 ~ "Status 2: Durable VAD",
    CriteriaMcsdMalfunction == 1 ~ "Status 2: MCSD malfunction",
    CriteriaMcsdEndovasSupp == 1 ~ "Status 2: Endovascular MCSD",
    CriteriaIabpSupport == 1 ~ "Status 2: IABP",
    CriteriaVentEpisode == 1 ~ "Status 2: Ventricular episodes",
    TRUE ~ "Status 2: Exception"))

init_list_post <- init_list_post %>% 
  left_join(just_stat2_post %>% 
              filter(PX_ID %in% init_just_forms$PX_ID) %>%
              group_by(PX_ID) %>% 
              slice_min(ChangeDate, with_ties = FALSE) %>% 
              ungroup() %>% 
              select(stat2_criteria, McsdCardiacIndex, McsdCapWedgePressure,
                     McsdSystolicBloodPressure, McsdWithoutHemoSbp,
                     McsdWithoutHemoArtLac, McsdWithoutHemoAst,
                     McsdWithoutHemoAlt, IabpCardiacIndex, IabpCapWedgePressure,
                     IabpSystolicBloodPressure, IabpWithoutHemoSbp, 
                     IabpWithoutHemoArtLac, IabpWithoutHemoAst, 
                     IabpWithoutHemoAlt, PX_ID), 
            by = "PX_ID")

just_stat3_post <- just_stat3_post %>% 
  mutate(stat3_criteria = case_when(
    CriteriaLvadDiscSupport == 1 ~ "Status 3: Dischargeable LVAD discretionary time",
    CriteriaInotropeSupport == 1 ~ "Status 3: Inotropes with hemodynamic monitoring",
    CriteriaMcsdWithHemo == 1 ~ "Status 3: MCSD with hemolysis",
    CriteriaMcsdWithPump == 1 ~ "Status 3: MCSD with pump thrombosis",
    CriteriaMcsdWithRhf == 1 ~ "Status 3: MCSD with RHF",
    CriteriaMcsdInfection == 1 ~ "Status 3: MCSD with device infection",
    CriteriaMcsdMucosalBleed == 1 ~ "Status 3: MCSD with bleeding",
    CriteriaMcsdWithAI == 1 ~ "Status 3: MCSD with AI",
    CriteriaVaEcmoSupport == 1 ~ "Status 3: ECMO after 7 days",
    CriteriaLvadSupport == 1 ~ "Status 3: Non-dischargeable LVAD after 14 days",
    CriteriaPercuSupport == 1 ~ "Status 3: Endovascular MCSD after 14 days",
    CriteriaIabpSupport == 1 ~ "Status 3: IABP after 14 days",
    TRUE ~ "Status 3: Exception"))

init_list_post <- init_list_post %>% 
  left_join(just_stat3_post %>% 
              filter(PX_ID %in% init_just_forms$PX_ID) %>%
              group_by(PX_ID) %>% 
              slice_min(ChangeDate, with_ties = FALSE) %>% 
              ungroup() %>% 
              select(stat3_criteria, InoCardiacIndex, InoCapWedgePressure,
                     InoSysBloodPressure, McsdLactateDehydrogenase,
                     McsdPlasmaFreeHemoglobin, McsdHemoglobinuria,
                     McsdWithPumpTransIscAttack, McsdWithRhfPcwp,
                     McsdWithRhfVenPressure, MucosalBleedNumHosp, PX_ID), 
            by = "PX_ID")

just_stat4_post <- just_stat4_post %>% 
  mutate(stat4_criteria = case_when(
    CriteriaLvadSupport == 1 ~ "Status 4: Dischargeable LVAD without discretionary time",
    CriteriaInotropeSupport == 1 ~ "Status 4: Inotropes without hemodynamic monitoring",
    CriteriaHeartDisease == 1 ~ "Status 4: Congenital heart disease",
    CriteriaIschemicHeart == 1 ~ "Status 4: Ischemic heart disease with intractable angina",
    CriteriaCardiomyopathy == 1 ~ "Status 4: Amyloidosis, HCM, or RCM",
    CriteriaRetransplant == 1 ~ "Status 4: Re-transplant",
    TRUE ~ "Status 4: Exception"))

init_list_post <- init_list_post %>% 
  left_join(just_stat4_post %>% 
              filter(PX_ID %in% init_just_forms$PX_ID) %>%
              group_by(PX_ID) %>% 
              slice_min(ChangeDate, with_ties = FALSE) %>% 
              ungroup() %>% 
              select(stat4_criteria, InotropeCardiacIndex, InotropePcwp, PX_ID),
            by = "PX_ID")

init_list_post <- init_list_post %>% 
  mutate(status_criteria = coalesce(stat1_criteria, 
                                    stat2_criteria, 
                                    stat3_criteria, 
                                    stat4_criteria)) %>%
  mutate(status_criteria = 
           ifelse(is.na(status_criteria), "Status 6", status_criteria)) %>% 
  select(-stat1_criteria, -stat2_criteria, -stat3_criteria, -stat4_criteria)
```

# 5. Add first risk stratification datum for each candidate to init_list_post

```{r}
init_risk_strat_data <- risk_strat_post %>% 
  group_by(PX_ID) %>% 
  slice_min(ChangeDate, with_ties = FALSE) %>% 
  ungroup()

init_list_post <- init_list_post %>% 
  left_join(risk_strat_post %>% 
              filter(PX_ID %in% init_risk_strat_data$PX_ID) %>%
              group_by(PX_ID) %>% 
              slice_min(ChangeDate, with_ties = FALSE) %>% 
              ungroup() %>% 
              select(CandHistStroke, CandHistThromb, CPTestMvo2, CPTestRer, 
                     CPTestVeVco2, SenDataCpra, SenDataMfiThreshold, HemoSbp, 
                     HemoDbp, HemoRestingHeartRate, HemoCvp, HemoPasp, HemoPadp,
                     HemoMeanPressure, HemoPcwp, HemoLvedp, HemoCardiacOutput, 
                     HemoCardiacIndex, HemoSvo2, HemoHemoglobin, VadLdhLevels, 
                     VadPlasmaFreeHemo, VadHemoglobinuria, HrSevFailSodium, 
                     HrSevFailCreatinine, HrSevFailBun, HrSevFailAlbumin, 
                     HrSevFailAsparTrans, HrSevFailBilirubin, 
                     HrSevFailArterialLact, HrSevFailInr, HrSevFailBnp, PX_ID), 
            by = "PX_ID")
```

# 6. Write out csv of initial listing state during post-policy era

```{r}
# not run
# write_csv(init_list_post, file = "initial_listing_state.csv")
```

# 7. Create pre-policy initial listing state

```{r}

policy_switch_2006 <- mdy("07/01/2006")

# filter candidates based on inclusion/exclusion criteria to create initial listing state
init_list_pre <- cand_thor %>% 
  filter(CAN_LISTING_DT >= policy_switch_2006 &
           CAN_LISTING_DT < policy_switch_date) %>% 
  filter(WL_ORG == "HR") %>% 
  # filter(CAN_INIT_STAT != 2150) %>% 
  filter(CAN_AGE_AT_LISTING > 17) %>% 
  filter(!(PX_ID %in% multi_organ_recipients$PX_ID))

# Status 1A justification forms from post-policy era
statjust_1a_pre <- stat_just_hr1a %>% filter(PX_ID %in% init_list_pre$PX_ID)

# Status 1B justification forms from post-policy era
statjust_1b_pre <- stat_just_hr1b %>% filter(PX_ID %in% init_list_pre$PX_ID)

# this line selects the 46 variables in cand_thor currently used in analysis
init_list_pre <- init_list_pre %>% select(all_of(cand_thor_selected_vars))
```

# 8. Add initial justification form for each candidate to init_list_pre 

```{r}
init_just_1a <- statjust_1a_pre %>% 
  group_by(PX_ID) %>% 
  slice_min(CANHX_CHG_DT, with_ties = FALSE) %>% 
  ungroup()

init_list_pre <- init_list_pre %>% 
  left_join(statjust_1a_pre %>% 
              filter(PX_ID %in% init_just_1a$PX_ID) %>%
              group_by(PX_ID) %>% 
              slice_min(CANHX_CHG_DT, with_ties = FALSE) %>% 
              ungroup() %>% 
              select(WL_ORG:CANHX_DGN), by = "PX_ID")

init_just_1b <- statjust_1b_pre %>% 
  group_by(PX_ID) %>% 
  slice_min(CANHX_CHG_DT, with_ties = FALSE) %>% 
  ungroup()

init_list_pre <- init_list_pre %>% 
  left_join(statjust_1b_pre %>% 
              filter(PX_ID %in% init_just_1b$PX_ID) %>%
              group_by(PX_ID) %>% 
              slice_min(CANHX_CHG_DT, with_ties = FALSE) %>% 
              ungroup() %>% 
              select(WL_ORG:CANHX_DGN), by = "PX_ID")
```

# Merge data sets to create time series
Filter status history file and select key variables

* Status 1A = 2010
* Status 1B = 2020
* Status 2 = 2030
* Inactive = 2999
```{r select_historys, echo = TRUE }
hist <- stathist_thor %>% filter(PX_ID %in% init_list$PX_ID) %>% 
	mutate(date_start = CANHX_BEGIN_DT, 
	       date_end = CANHX_END_DT, 
	       status = CANHX_STAT_CD, 
	       real_status = CANHX_STAT_CD, 
	       rem_dt = CAN_REM_DT) %>% 
	arrange(PX_ID, date_start) %>% 
  select(PX_ID, status, real_status, date_start, date_end, rem_dt,  CAN_REM_CD)
hist <- distinct(hist, PX_ID, date_start, .keep_all = TRUE)
remove(stathist_thor)
#preview status history data set
hist
```

Filter status 1A justification file and select key variables
```{r select_just_1a}
just_1a <- statjust_hr1a %>% 
  filter(PX_ID %in% init_list$PX_ID)  %>% 
	mutate(date_start = CANHX_CHG_DT, 
		status = CANHX_STAT_CD) %>% 
	arrange(PX_ID, date_start) 
#remove redundant or erroneous justifications
just_1a <- distinct(just_1a) %>% 
  filter(CANHX_FORM_STAT == 4 | CANHX_FORM_STAT == 8) %>% 
  distinct(PX_ID, date_start, .keep_all = TRUE)
#select key variables
just_1a <- just_1a %>% select(PX_ID, CAN_LISTING_CTR_ID, 
  status, date_start, CANHX_STAT_TY, CANHX_FORM_STAT, 
	CANHX_DIALYSIS, CANHX_LAB_SERUM_CREAT, 
	CANHX_ADULT_CRITERIA_A, CANHX_ADULT_CRITERIA_B, 
  CANHX_ADULT_CRITERIA_C, CANHX_ADULT_CRITERIA_D, 
  CANHX_ADULT_CRITERIA_E, CANHX_INTRP_DOBU, CANHX_INTRP_DOPA, CANHX_INTRP_MILRIN,
	CANHX_ADMITTED, 
	CANHX_IABP, CANHX_ECMO, CANHX_LVAD_TYPE, CANHX_VAD, CANHX_TAH, CANHX_RVAD_TYPE,
	CANHX_LAB_BILI, 
	CANHX_CARD_OUTPUT, CANHX_HEMO_CI, CANHX_HEMO_INTRP_OBTAINED, CANHX_HEMO_BSA,
	CANHX_HEMO_PCWP,
	CANHX_HEMO_MPAP,
	CANHX_DEV_MALFUNCTN,
	CANHX_DEV_VENT_ARRYTHM
	)
remove(statjust_hr1a)
just_1a
```


Filter status 1B justifcation file and select key variables. These forms have a lot less information, mainly just report VAD vs. inotropes
```{r select_1b}
just_1b <- statjust_hr1b %>% filter(PX_ID %in% init_list$PX_ID) %>% 
	mutate(date_start = CANHX_CHG_DT, 
		status = CANHX_STAT_CD, 
		stable_lvad = CANHX_VAD, 
		except_1b =CANHX_CRIT_NOT_MET,
		low_dose_ino = pmax(CANHX_REQUIRE_LOW_INOTROP, CANHX_CONT_IV_INOTROP)
		) %>% 
	arrange(PX_ID, date_start)
just_1b <- distinct(just_1b) %>% 
  filter(CANHX_FORM_STAT == 4 | CANHX_FORM_STAT == 8) %>%	
  distinct(PX_ID, date_start, .keep_all = TRUE)
just_1b <- just_1b %>% 
  select(PX_ID, CAN_LISTING_CTR_ID, status, date_start, 
	low_dose_ino, stable_lvad, except_1b
	)
remove(statjust_hr1b) 
just_1b
```


Merge data sets to create time series
```{r create_cand_time_series, message = FALSE, warning = FALSE }
#merge with history 
cand_time_series <- init_list %>% 
  mutate(int_form =1, rem_cd = CAN_REM_CD) %>% 
  full_join(hist, c("PX_ID", "date_start", "status"), suffix = c(".init", ".hist")) %>% 
  arrange(PX_ID, date_start)
#merge with 1A justifications, keeping justification forms in the middle of a history period
cand_time_series <- cand_time_series %>% 
  full_join(just_1a, by = c("PX_ID", "date_start", "status"), suffix = c(".init", ".j1a"))  %>% 
  arrange(PX_ID, date_start)
#merge with 1B justiciations, keeping justification forms in the middle of a history period
cand_time_series <- cand_time_series %>% 
  full_join(just_1b, by = c("PX_ID", "date_start", "status"), suffix = c(".init", ".j1b")) %>% 
  arrange(PX_ID, date_start) 
#carryforward "real status" status history dataset
cand_time_series <- cand_time_series %>% arrange(PX_ID, date_start) %>% 
  group_by(PX_ID) %>% 
  mutate(real_status = na.locf(real_status, na.rm = FALSE)) %>% 
  ungroup() 
#remove justification forms that didn't actually change offical status
cand_time_series <- cand_time_series %>% 
  filter(real_status == status | int_form ==1)
```


# 9. Write out csv of initial listing state of pre-policy era

```{r}
write_csv(init_list_pre, file = "initial_listing_state_pre_policy.csv")
```

# 10. Upload csv to shared Box folder

```{r}
dir_id <- "147979342314"


```

